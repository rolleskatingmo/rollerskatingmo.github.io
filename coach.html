<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>教練後台 · 輪滑課程管理系統</title>
<style>
    .student-button.selected {
    background: #fbbf24 !important;  /* 黃色表示待提交 */
    border-color: #f59e0b !important;
    color: #78350f !important;
}
.student-button.selected .class-count {
    background: #f59e0b;
    color: white;
}
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: #f1f5f9;
        padding: 12px;
        color: #0f172a;
        line-height: 1.5;
    }
    .container {
        max-width: 100%;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 32px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        padding: 24px 20px;
    }
    h1 {
        font-size: clamp(1.4rem, 5vw, 1.8rem);
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
        letter-spacing: -0.02em;
        line-height: 1.3;
    }
    /* 頂部用戶資訊欄 - 請在 HTML 中添加 class="user-bar" */
    .user-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .user-info {
        background: #e6f0ff;
        padding: 8px 20px;
        border-radius: 40px;
        font-size: 0.95rem;
        font-weight: 600;
        color: #1e4a7a;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
    .user-bar .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    /* 按鈕網格 */
    .button-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 24px 0;
    }
    .btn, .btn-sm, .student-button, .rental-button, .class-badge[onclick] {
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border: none;
        font-weight: 500;
        cursor: pointer;
        border-radius: 40px;
    }
    .btn {
        padding: 14px 20px;
        font-size: 1rem;
        flex: 1 0 calc(50% - 12px);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        background: #ffffff;
        color: #1e293b;
        border: 1px solid #e2e8f0;
    }
    .btn-primary { background: #2563eb; color: white; border: none; }
    .btn-success { background: #16a34a; color: white; border: none; }
    .btn-warning { background: #ea580c; color: white; border: none; }
    .btn-danger { background: #dc2626; color: white; border: none; }
    .btn-purple { background: #9333ea; color: white; border: none; }
    .btn-indigo { background: #4f46e5; color: white; border: none; }
    .btn-rental { background: #0891b2; color: white; border: none; }

    .btn:hover, .btn-sm:hover, .student-button:hover:not(:disabled), .rental-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .btn:active, .btn-sm:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:disabled, .btn-sm:disabled, .student-button:disabled, .rental-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .trial-alert {
        background: #fffbeb;
        border: 1px solid #fcd34d;
        border-radius: 20px;
        padding: 16px 20px;
        margin-bottom: 24px;
    }
    .trial-alert h3 {
        color: #92400e;
        margin-bottom: 12px;
        font-size: 1.1rem;
        font-weight: 600;
    }
    .trial-alert-item {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px dashed #fcd34d;
    }
    .trial-alert-item:last-child { border-bottom: none; }
    .trial-alert-item span { flex: 1; font-size: 0.95rem; }
    .trial-alert-item .paid-tag {
        background: #16a34a;
        color: white;
        padding: 4px 14px;
        border-radius: 40px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .trial-alert-item button {
        background: #16a34a;
        color: white;
        border: none;
        padding: 6px 16px;
        border-radius: 40px;
        cursor: pointer;
        font-weight: 500;
    }
    .trial-alert-item button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .section {
        background: #ffffff;
        border-radius: 28px;
        padding: 24px 20px;
        margin-bottom: 30px;
        border: 1px solid #e9eef2;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
    }
    .section h2 {
        font-size: clamp(1.2rem, 4vw, 1.4rem);
        font-weight: 600;
        margin-bottom: 20px;
        color: #0f172a;
        letter-spacing: -0.01em;
    }
    .section h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 16px 0 8px;
        color: #334155;
    }

    .class-badge {
        display: inline-block;
        background: #2563eb;
        color: white;
        padding: 8px 18px;
        border-radius: 40px;
        margin: 0 8px 8px 0;
        font-size: 0.9rem;
        font-weight: 500;
        word-break: break-word;
        transition: 0.2s;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }
    .class-badge[onclick] {
        cursor: pointer;
    }
    .class-badge[onclick]:hover {
        filter: brightness(1.1);
        transform: scale(1.02);
    }

    .student-button, .rental-button {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        padding: 10px 20px;
        border-radius: 40px;
        margin: 6px;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.95rem;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .student-button .class-count {
        background: #e2e8f0;
        padding: 4px 12px;
        border-radius: 40px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #1e293b;
    }
    .student-button.zero-class {
        background: #fee2e2 !important;
        border-color: #fecaca !important;
        color: #991b1b !important;
    }
    .student-button.zero-class .class-count {
        background: #fecaca;
        color: #7f1d1d;
    }
    .student-button.checked {
        background: #bbf7d0 !important;
        border-color: #86efac !important;
        color: #166534 !important;
        opacity: 0.9;
        cursor: not-allowed;
    }
    .student-button.checked .class-count {
        background: #86efac;
        color: #14532d;
    }
    .rental-button {
        background: #0891b2;
        color: white;
        border: none;
        min-width: 90px;
    }

    .form-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 20px;
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1 1 200px;
    }
    label {
        font-weight: 600;
        font-size: 0.85rem;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    input, select, textarea {
        padding: 14px 16px;
        border: 1px solid #d1d9e6;
        border-radius: 20px;
        font-size: 1rem;
        width: 100%;
        background: #ffffff;
        transition: border 0.2s, box-shadow 0.2s;
        font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    .search-dropdown {
        position: relative;
        width: 100%;
    }
    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d9e6;
        border-radius: 20px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        display: none;
    }
    .dropdown-item {
        padding: 14px 18px;
        cursor: pointer;
        border-bottom: 1px solid #edf2f7;
        font-size: 0.95rem;
        transition: background 0.15s;
    }
    .dropdown-item:hover { background: #f1f5f9; }
    .dropdown-item:last-child { border-bottom: none; }

    .message {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        min-width: 240px;
        max-width: 90%;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 30000;
        transition: opacity 0.3s ease;
        pointer-events: none;
        background: transparent; /* 外層透明，背景由內層 div 提供 */
    }
    .message > div {
        padding: 14px 24px;
        border-radius: 50px;
        backdrop-filter: blur(10px);
    }
    .success {
        background: rgba(34, 197, 94, 0.7);
        color: white;
    }
    .error {
        background: rgba(239, 68, 68, 0.7);
        color: white;
    }

    #loginForm {
        max-width: 400px;
        margin: 80px auto;
        background: white;
        padding: 40px 30px;
        border-radius: 40px;
        box-shadow: 0 20px 35px -8px rgba(0,0,0,0.1);
        text-align: center;
    }
    #loginForm h2 {
        font-size: clamp(1.8rem, 6vw, 2rem);
        margin-bottom: 20px;
        color: #0f172a;
    }
    #loginForm input {
        margin: 12px 0;
        padding: 16px;
    }

    .student-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8fafc;
        padding: 16px 20px;
        border-radius: 24px;
        margin-bottom: 12px;
        border: 1px solid #e9eef2;
        flex-wrap: wrap;
        gap: 12px;
        transition: 0.2s;
    }
    .student-row:hover {
        background: #f1f5f9;
    }
    .student-row .details {
        flex: 1;
        min-width: 200px;
    }
    .student-row .details .name-with-icons {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 4px;
    }
    .student-row .details .icons span { font-size: 1.1rem; }
    .student-row .details .stats {
        display: flex;
        gap: 10px;
        margin-top: 6px;
        flex-wrap: wrap;
    }
    .student-row .details .note {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 6px;
        word-break: break-word;
        background: #ffffff;
        padding: 6px 12px;
        border-radius: 30px;
        display: inline-block;
    }
    .student-row .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
        border-radius: 40px;
        border: none;
        cursor: pointer;
        background: #ffffff;
        border: 1px solid #d1d9e6;
        transition: 0.2s;
        min-width: 70px;
        font-weight: 500;
        color: #1e293b;
    }
    .btn-sm:hover {
        background: #f1f5f9;
        border-color: #a0b3c9;
    }
    .btn-sm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .leave-badge, .rental-badge, .class-badge-stat {
        padding: 5px 14px;
        border-radius: 40px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .leave-badge { background: #ef4444; color: white; }
    .rental-badge { background: #0891b2; color: white; }
    .class-badge-stat { background: #2563eb; color: white; }

    .info-box {
        background: #e6f0ff;
        border-left: 4px solid #2563eb;
        padding: 16px 20px;
        margin-bottom: 24px;
        border-radius: 20px;
        font-size: 0.95rem;
        color: #1e3a8a;
    }

    /* 折疊樣式 */
    .class-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 20px 0 12px;
        cursor: pointer;
        user-select: none;
        padding: 6px 12px;
        background: #f1f5f9;
        border-radius: 40px;
    }
    .class-header h3 { margin: 0; font-size: 1.2rem; }
    .class-header .toggle-icon {
        font-size: 1.2rem;
        transition: transform 0.2s;
        color: #475569;
    }
    .class-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    .class-students {
        transition: max-height 0.3s ease;
        overflow: hidden;
    }
    .class-students.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0;
    }

    /* 載入中動畫 */
    #loadingSpinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.7);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 20000;
        color: white;
        text-align: center;
        backdrop-filter: blur(5px);
    }
    #loadingSpinner .spinner {
        border: 5px solid rgba(255,255,255,0.2);
        border-top: 5px solid white;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        animation: spin 1s linear infinite;
        margin-bottom: 25px;
    }
    #loadingSpinner p {
        font-size: 1.2rem;
        font-weight: 500;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* 自訂模態對話框 */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: white;
        border-radius: 36px;
        padding: 30px;
        max-width: 90%;
        width: 500px;
        box-shadow: 0 30px 40px -15px rgba(0,0,0,0.2);
        animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    .modal-content h3 {
        margin-bottom: 20px;
        color: #0f172a;
        font-weight: 600;
        font-size: 1.4rem;
    }
    .modal-content input,
    .modal-content select,
    .modal-content textarea {
        width: 100%;
        padding: 14px;
        border: 1px solid #d1d9e6;
        border-radius: 24px;
        margin-bottom: 20px;
        font-size: 1rem;
    }
    .modal-buttons {
        display: flex;
        gap: 16px;
        justify-content: flex-end;
    }
    .modal-buttons button {
        padding: 12px 24px;
        border: none;
        border-radius: 40px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        font-size: 0.95rem;
    }
    .modal-buttons .confirm {
        background: #2563eb;
        color: white;
        border: none;
    }
    .modal-buttons .confirm:hover { background: #1d4ed8; }
    .modal-buttons .cancel {
        background: #f1f5f9;
        color: #334155;
        border: 1px solid #cbd5e1;
    }
    .modal-buttons .cancel:hover { background: #e2e8f0; }

    /* 通知欄 */
    .notification-section {
        background: #ffffff;
        border-radius: 24px;
        margin-bottom: 24px;
        border: 1px solid #e9eef2;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.02);
    }
    .notification-header {
        background: #f1f5f9;
        color: #0f172a;
        padding: 18px 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        user-select: none;
        font-size: 1.1rem;
    }
    .notification-header .toggle-icon {
        font-size: 1.2rem;
        transition: transform 0.2s;
    }
    .notification-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    .notification-body {
        transition: max-height 0.3s ease;
        overflow: hidden;
    }
    .notification-body.collapsed {
        max-height: 0;
        opacity: 0;
        padding: 0 16px;
    }
    .notification-item {
        padding: 18px 20px;
        border-bottom: 1px solid #edf2f7;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
    }
    .notification-item:last-child { border-bottom: none; }
    .notification-item .type-tag {
        background: #2563eb;
        color: white;
        padding: 5px 14px;
        border-radius: 40px;
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 70px;
        text-align: center;
    }
    .notification-item .content { flex: 1; min-width: 200px; }
    .notification-item .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* 手機專屬調整 */
    @media screen and (max-width: 600px) {
        body { padding: 8px; }
        .container { padding: 20px 16px; border-radius: 24px; }
        h1 { font-size: clamp(1.3rem, 5vw, 1.6rem); }
        .button-grid { gap: 8px; }
        .btn { flex: 1 0 calc(50% - 8px); padding: 12px 12px; font-size: 0.9rem; }
        .section { padding: 20px 16px; border-radius: 24px; }
        .section h2 { font-size: clamp(1.1rem, 4vw, 1.3rem); }
        .form-group { flex: 1 1 100%; }
        .student-button, .rental-button { font-size: 0.85rem; padding: 8px 16px; margin: 4px; }
        .student-row { padding: 14px 16px; }
        .student-row .actions { width: 100%; justify-content: flex-start; }
        .btn-sm { padding: 6px 14px; font-size: 0.8rem; }
        .modal-content { padding: 25px 20px; border-radius: 30px; }
        .modal-content h3 { font-size: 1.3rem; }
        .modal-buttons button { padding: 10px 20px; }
        .class-header { margin: 16px 0 8px; padding: 8px 16px; }
        .class-header h3 { font-size: 1.1rem; }
        .notification-item { padding: 14px 16px; }
        .notification-item .type-tag { min-width: 60px; font-size: 0.75rem; }
        /* 頂部用戶欄調整 */
        .user-bar {
            gap: 8px;
            margin-bottom: 12px;
        }
        .user-info {
            font-size: 0.9rem;
            padding: 6px 16px;
            max-width: 100%;
            flex: 1 1 auto;
        }
        .user-bar .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-width: 60px;
        }
    }

    /* 超小螢幕（如 iPhone SE） */
    @media screen and (max-width: 380px) {
        .btn { flex: 1 0 100%; }
        .student-button, .rental-button { width: 100%; margin: 4px 0; }
        .student-row .details .stats { flex-direction: column; align-items: flex-start; }
        .user-bar {
            flex-direction: column;
            align-items: stretch;
        }
        .user-info {
            text-align: center;
        }
        .user-bar .btn-sm {
            width: 100%;
        }
    }

    /* 若您不想修改 HTML，可使用以下備用方案強制覆蓋內聯樣式（不建議） */
    /*
    #mainContent > div:first-child {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
        justify-content: flex-end !important;
    }
    #mainContent > div:first-child .user-info {
        flex: 1 1 auto !important;
    }
        /* 頁腳樣式 */
    .footer {
        margin-top: 40px;
        font-size: 0.8rem;
        color: #64748b;
        text-align: center;
        border-top: 1px solid #e2e8f0;
        padding-top: 20px;
    }
    .footer p {
        margin-bottom: 5px;
    }

    /* 手機適配 */
    @media screen and (max-width: 600px) {
        .footer {
            margin-top: 30px;
            font-size: 0.75rem;
        }
    }
    */
</style>
</head>
<body>
    <div id="loginForm">
        <h2>🔐 教練專區</h2>
        <input type="text" id="username" placeholder="用戶名" style="margin:10px 0; padding:14px;">
        <input type="password" id="password" placeholder="密碼" style="margin:10px 0; padding:14px;">
        <button class="btn btn-primary" onclick="login()" style="width:100%;">登入</button>
        <div id="loginMessage" style="margin-top:15px;"></div>
    </div>
    <div id="mainContent" class="container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <div class="user-bar">
    <div class="user-info" id="userInfoDisplay"></div>
    <button class="btn-sm" id="changePasswordBtn" onclick="openChangePasswordModal()">🔑 修改密碼</button>
    <button class="btn-sm" onclick="logout()">🚪 登出</button>
</div>
        </div>
        <h1>⚙️ 輪滑課程管理系統</h1>

        <!-- 通知欄位（預設展開） -->
        <div id="notificationSection" class="notification-section">
            <div id="notificationHeader" class="notification-header" onclick="toggleNotificationBody()">
                <span class="toggle-icon">▼</span>
                <span>📢 待辦通知</span>
                <span id="notificationCount" style="background:#e53e3e; padding:2px 10px; border-radius:30px; font-size:0.8rem;">0</span>
            </div>
            <div id="notificationBody" class="notification-body"></div>
        </div>

        <!-- 載入中提示 -->
        <div id="loadingSpinner">
            <div class="spinner"></div>
            <p>載入中，請稍後...</p>
        </div>

        <!-- 應用內容 -->
        <div id="appContent" style="display: none;">
            <div id="buttonGrid" class="button-grid">
                <button id="btnAttendance" class="btn btn-primary" onclick="showSection('attendance')">📋 點名</button>
                <button id="btnRental" class="btn btn-rental" onclick="showSection('rental')">🛞 租借裝備</button>
                <button id="btnTrial" class="btn btn-indigo" onclick="showSection('trial')">🧪 試堂管理</button>
                <button id="btnPaymentUpload" class="btn btn-success" style="display:none;" onclick="document.getElementById('paymentUploadInput').click();">💰 上傳繳費憑證</button>
                <input type="file" id="paymentUploadInput" accept="image/*" style="display: none;">
                <button id="btnPhoto" class="btn" onclick="document.getElementById('photoUploadInput').click();">📸 上傳課堂相片</button>
                <input type="file" id="photoUploadInput" accept="image/*" style="display: none;">
                <button id="btnAddClasses" class="btn btn-success" onclick="showSection('addClasses')">➕ 新增/扣課</button>
                <button id="btnAddStudent" class="btn btn-indigo" onclick="showSection('addStudent')">👤 新增學生</button>
                <button id="btnClassManage" class="btn btn-warning" onclick="showSection('classManage')" style="display:none;">🏫 班級管理</button>
                <button id="btnClear" class="btn btn-danger" onclick="showSection('clear')">📋 學生資訊</button>
                <button id="btnCoachLeave" class="btn btn-purple" onclick="showSection('coachLeave')">📝 請假</button>
                <button id="btnMakeupAttendance" class="btn btn-warning" onclick="openMakeupDateModal()">📅 補點名</button>
                <button id="btnUserManage" class="btn btn-primary" onclick="showSection('userManage')" style="background:#6b46c1; display:none;">👥 用戶管理</button>
            </div>

            <!-- 點名區塊 -->
            <div id="attendance" class="section" style="display: none;">
                <h2>📌 點名 (扣課)</h2>
                <div id="attendanceList"></div>
                <button id="resetAttendanceBtn" class="btn btn-warning" onclick="resetAttendance()" style="margin-top:20px;">重置點名狀態</button>
            </div>

            <!-- 租借裝備區塊 -->
            <div id="rental" class="section" style="display: none;">
                <h2>🛞 裝備租借 (每次 $20)</h2>
                <div id="rentalList"></div>
            </div>

            <!-- 試堂管理區塊 -->
            <div id="trial" class="section" style="display: none;">
                <h2>🧪 試堂管理</h2>
                <div class="info-box">試堂學生僅記錄一堂，過期未付費會在上方通知欄提醒。</div>
                <div class="form-row" id="trialAddForm" style="display:none;">
                    <div class="form-group"><label>姓名</label><input type="text" id="trialName"></div>
                    <div class="form-group"><label>試堂日期</label><input type="date" id="trialDate"></div>
                    <div class="form-group"><label>租借裝備</label><select id="trialRent"><option value="false">否</option><option value="true">是</option></select></div>
                    <div class="form-group"><label>已付費</label><select id="trialPaid"><option value="false">否</option><option value="true">是</option></select></div>
                    <div class="form-group"><label>備註</label><input type="text" id="trialNote"></div>
                    <button class="btn btn-indigo" onclick="addTrial()" style="width:100%;">新增試堂學生</button>
                </div>
                <h3>📋 試堂學生記錄</h3>
                <div id="trialList"></div>
            </div>

            <!-- 新增/扣課區塊 -->
            <div id="addClasses" class="section" style="display: none;">
                <h2>➕ 新增 / 扣減課堂</h2>
                <div class="info-box">💡 輸入姓名關鍵字選擇學生，班級自動帶入。教練操作需管理員審批。</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>🔍 搜尋學生</label>
                        <div class="search-dropdown">
                            <input type="text" id="searchStudentInput" placeholder="輸入姓名關鍵字" autocomplete="off">
                            <div id="studentDropdown" class="dropdown-list"></div>
                        </div>
                    </div>
                    <div class="form-group"><label>班級</label><input type="text" id="selectedClass" readonly></div>
                    <div class="form-group"><label>課堂變動</label><input type="number" id="addClassDelta" value="10"></div>
                    <div class="form-group"><label>原因</label><textarea id="addClassReason" placeholder="續費10堂"></textarea></div>
                    <button class="btn btn-success" onclick="submitAddClasses()" style="width:100%;">提交審批</button>
                </div>
                <div id="addClassesMessage"></div>
            </div>

            <!-- 新增學生區塊 -->
            <div id="addStudent" class="section" style="display: none;">
                <h2>👤 新增學生（預設10堂）</h2>
                <div class="info-box">🎁 新學生自動獲得 10 堂課，租借次數0。特別備註僅完整權限可見。教練操作需管理員審批。</div>
                <div class="form-row">
                    <div class="form-group"><label>姓名</label><input type="text" id="newStudentName"></div>
                    <div class="form-group"><label>班級</label><select id="newStudentClass"></select></div>
                    <div class="form-group"><label>特別備註</label><input type="text" id="newStudentNote" placeholder="選填，僅教練查看"></div>
                    <button class="btn btn-indigo" onclick="submitAddStudent()" style="width:100%;">提交審批</button>
                </div>
                <div id="addStudentMessage"></div>
            </div>

            <!-- 班級管理區塊 -->
            <div id="classManage" class="section" style="display: none;">
                <h2>🏫 班級管理</h2>
                <div class="form-row">
                    <div class="form-group"><label>新增班級</label><input type="text" id="newClassName" placeholder="D1"></div>
                    <button class="btn btn-primary" onclick="addNewClass()" style="width:100%;">新增班級</button>
                </div>
                <h3>現有班級</h3>
                <div id="classListContainer" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>

            <!-- 學生資訊區塊 -->
            <div id="clear" class="section" style="display: none;">
                <h2>📋 學生資訊</h2>
                <div id="noteListByClass"></div>
            </div>

            <!-- 教練代請假區塊 -->
            <div id="coachLeave" class="section" style="display: none;">
                <h2>📝 教練代為請假</h2>
                <div class="info-box">🔍 輸入姓名關鍵字選擇學生。</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>🔍 搜尋學生</label>
                        <div class="search-dropdown">
                            <input type="text" id="coachLeaveSearchInput" placeholder="輸入姓名關鍵字" autocomplete="off">
                            <div id="coachLeaveDropdown" class="dropdown-list"></div>
                        </div>
                    </div>
                    <div class="form-group"><label>班級</label><input type="text" id="coachLeaveSelectedClass" readonly></div>
                    <button class="btn btn-purple" onclick="submitCoachLeave()" style="width:100%;">提交請假</button>
                </div>
                <div id="coachLeaveMessage"></div>
            </div>

            <!-- 用戶管理區塊 -->
            <div id="userManage" class="section" style="display: none;">
                <h2>👥 用戶管理</h2>
                <div class="info-box">🔐 管理員可新增、編輯、刪除用戶，並分配班級權限。</div>
                <div class="form-row">
                    <div class="form-group"><label>用戶名</label><input type="text" id="newUsername"></div>
                    <div class="form-group"><label>密碼</label><input type="text" id="newPassword" value="123456"></div>
                    <div class="form-group"><label>角色</label>
                        <select id="newRole">
                            <option value="assistant">助教</option>
                            <option value="coach">教練</option>
                            <option value="admin">管理員</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>授權班級 (點擊班級按鈕選取)</label>
                        <div id="classSelectionContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn-sm" onclick="clearAllSelectedClasses()">清除所有</button>
                            <span id="selectedClassesDisplay" style="font-size:0.85rem; color:#4a5568; align-self:center;"></span>
                        </div>
                        <input type="hidden" id="newAuthClasses" value="">
                    </div>
                    <button class="btn btn-success" id="addUserBtn" onclick="addUser()" style="width:100%;">新增用戶</button>
                </div>
                <h3>📋 現有用戶</h3>
                <div id="userList"></div>
            </div>

            <div id="message" class="message"></div>
<div class="footer">
    <p>🛼滾軸溜冰私教輪滑團隊🛼</p>
    <p>系統版本 Version 6.0 By Thomas哥哥</p>
</div>
        </div> <!-- end appContent -->
    </div>

    <!-- 隱藏日期輸入（用於 iPhone 日期選擇器修復） -->
    <input type="date" id="hiddenDatePicker" style="position: fixed; top: 0; left: 0; opacity: 0; pointer-events: none; width: 1px; height: 1px;" />

    <!-- 自訂模態對話框（用於編輯備註） -->
    <div id="noteModal" class="modal-overlay">
        <div class="modal-content">
            <h3>✏️ 編輯備註</h3>
            <input type="text" id="modalNoteInput" placeholder="請輸入新備註">
            <div class="modal-buttons">
                <button class="cancel" onclick="closeNoteModal()">取消</button>
                <button class="confirm" id="saveNoteBtn" onclick="saveNote()">儲存</button>
            </div>
        </div>
    </div>

    <!-- 自訂確認對話框 -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmTitle">確認操作</h3>
            <p id="confirmMessage">確定要執行此操作嗎？</p>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeConfirmModal()">取消</button>
                <button class="confirm" id="confirmBtn">確定</button>
            </div>
        </div>
    </div>

    <!-- 編輯用戶模態框 -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-content">
            <h3>✏️ 編輯用戶</h3>
            <input type="text" id="editUsername" readonly placeholder="用戶名">
            <input type="text" id="editPassword" placeholder="新密碼 (留空不變)">
            <select id="editRole">
                <option value="assistant">助教</option>
                <option value="coach">教練</option>
                <option value="admin">管理員</option>
            </select>
            <div class="form-group">
                <label>授權班級</label>
                <div id="editClassSelectionContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                <div style="display: flex; gap: 8px;">
                    <button type="button" class="btn-sm" onclick="clearEditSelectedClasses()">清除所有</button>
                    <span id="editSelectedClassesDisplay" style="font-size:0.85rem; color:#4a5568; align-self:center;"></span>
                </div>
                <input type="hidden" id="editAuthClasses" value="">
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeEditUserModal()">取消</button>
                <button class="confirm" onclick="saveUserEdit()">儲存</button>
            </div>
        </div>
    </div>

    <!-- 修改密碼模態框 -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-content">
            <h3>🔑 修改密碼</h3>
            <input type="password" id="oldPassword" placeholder="舊密碼" style="margin-bottom:10px;">
            <input type="password" id="newPassword1" placeholder="新密碼" style="margin-bottom:10px;">
            <input type="password" id="newPassword2" placeholder="確認新密碼" style="margin-bottom:20px;">
            <div class="modal-buttons">
                <button class="cancel" onclick="closeChangePasswordModal()">取消</button>
                <button class="confirm" onclick="submitChangePassword()">確認修改</button>
            </div>
        </div>
    </div>

    <!-- 繳費上傳-選擇學生模態框 -->
    <div id="paymentStudentModal" class="modal-overlay">
        <div class="modal-content">
            <h3>💰 選擇繳費學生</h3>
            <div class="form-group">
                <label>🔍 搜尋學生</label>
                <div class="search-dropdown">
                    <input type="text" id="paymentStudentSearch" placeholder="輸入姓名關鍵字" autocomplete="off">
                    <div id="paymentStudentDropdown" class="dropdown-list"></div>
                </div>
            </div>
            <div class="form-group">
                <label>班級</label>
                <input type="text" id="paymentSelectedClass" readonly>
            </div>
            <div class="form-group">
                <label>繳費日期</label>
                <input type="date" id="paymentDate">
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="closePaymentModal()">取消</button>
                <button class="confirm" onclick="confirmPaymentUpload()">下一步</button>
            </div>
        </div>
    </div>
<!-- 補點名日期選擇模態框 -->
<div id="makeupDateModal" class="modal-overlay">
    <div class="modal-content">
        <h3>📅 選擇補點名日期</h3>
        <input type="date" id="makeupDateInput" style="width:100%; margin-bottom:20px;">
        <div class="modal-buttons">
            <button class="cancel" onclick="closeMakeupDateModal()">取消</button>
            <button class="confirm" onclick="confirmMakeupDate()">下一步</button>
        </div>
    </div>
</div>
    <!-- 課堂相片-選擇班級模態框 -->
    <div id="classSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h3>📸 選擇班級</h3>
            <p>請選擇這張照片所屬的班級：</p>
            <select id="photoClassSelect" style="width:100%; margin-bottom:20px;">
                <option value="">-- 請選擇班級 --</option>
            </select>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeClassSelectModal()">取消</button>
                <button class="confirm" onclick="confirmClassSelection()">下一步</button>
            </div>
        </div>
    </div>

   <script>
    // ========== 後端網址 ==========
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzF8JqFUmYrSq_HR_3TOwDoywSFuJZA8cIFzupT3v0hsfhKIdTb7u2vu0bVvEav9qXb1A/exec';

    let allStudents = [];
    let isMakeupMode = false;      // 是否處於補點名模式
    let makeupSelectedStudents = new Set(); // 存放選中的學生姓名（用於補點名審批）
    let makeupDate = '';           // 當前選擇的補點名日期 (YYYY-MM-DD)
    let currentUser = null; // { username, role, authorizedClasses }
    const processing = {};

    // 當前操作的目標
    let currentNoteTarget = null;
    let currentConfirmCallback = null;
    let classCollapsed = {};
    let pendingNewStudent = null; // 暫存新學生通知的 { name, className }
    // 班級選擇相關
    let allClasses = [];
    let selectedClasses = new Set(); // 用於新增用戶或編輯用戶時選中的班級

    // 暫存檔案
    let selectedPaymentFile = null;
    let selectedPaymentStudent = null;
    let selectedPaymentClass = null;
    let selectedPhotoFile = null;

    // 通知資料
    let pendingApprovals = [];          // 待審批請求
    let trialNotifications = [];        // 試堂提醒（未付費或今日之後）
    let paymentNotifications = [];       // 繳費提醒（已繳費但學生剩餘0堂）
    let newStudentNotifications = [];    // 新學生提醒（剛新增，等待上傳繳費憑證）

    // 通知折疊狀態（預設展開）
    let notificationCollapsed = false;

    // ---------- 登入 ----------
    async function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!username || !password) return showLoginError('請輸入用戶名與密碼');

        const loginBtn = document.querySelector('#loginForm .btn-primary');
        const originalText = loginBtn.textContent;
        loginBtn.disabled = true;
        loginBtn.textContent = '登入中...';

        try {
            console.log('發送登入請求，用戶名:', username);
            const url = `${SCRIPT_URL}?action=verifyUser&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
            console.log('請求網址:', url);
            const res = await fetch(url);
            console.log('回應狀態碼:', res.status);
            if (!res.ok) {
                throw new Error(`HTTP 錯誤 ${res.status}`);
            }
            const data = await res.json();
            console.log('後端回應資料:', data);
if (data.success) {
    const role = (data.role || '').toLowerCase();
    currentUser = {
        username: data.username,
        role: role,
        authorizedClasses: data.authorizedClasses
    };
    // ✅ 將使用者資訊存入 localStorage（保持登入狀態）
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
                let roleName = '助教';
                if (role === 'admin') roleName = '管理員';
                else if (role === 'coach') roleName = '教練';
                document.getElementById('userInfoDisplay').textContent = `👤 ${data.username} (${roleName})`;
                document.getElementById('loadingSpinner').style.display = 'flex';
                document.getElementById('appContent').style.display = 'none';
                await loadAllData();
            } else {
                showLoginError(data.error || '用戶名或密碼錯誤');
            }
        } catch (e) {
            console.error('登入過程錯誤:', e);
            showLoginError('連線失敗: ' + e.message);
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = originalText;
        }
    }
    // ---------- 登出函數 ----------
function logout() {
    // 清除 localStorage 中的使用者資訊
    localStorage.removeItem('currentUser');
    currentUser = null;
    allStudents = [];

    // 隱藏主要內容，顯示登入表單
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('loginMessage').innerHTML = '';

    // 清除點名狀態（按鈕樣式及 localStorage 標記）
    document.querySelectorAll('.student-button.checked').forEach(b => {
        b.classList.remove('checked');
        b.disabled = false;
    });
    allStudents.forEach(s => localStorage.removeItem(`attendance_${s.name}`));

    // 重設班級折疊狀態
    classCollapsed = {};

    // 隱藏通知欄的內容（可選）
    document.getElementById('notificationBody').innerHTML = '';
    document.getElementById('notificationCount').textContent = '0';
}
    function showLoginError(msg) {
        document.getElementById('loginMessage').innerHTML = `<span class="error">${msg}</span>`;
    }
// 平滑滾動到指定區塊
function scrollToSection(sectionId) {
    setTimeout(() => {
        const element = document.getElementById(sectionId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 150); // 延遲 150ms 確保內容已渲染
}
    // ---------- 載入所有資料 ----------
// ---------- 載入所有資料（並行優化）----------
async function loadAllData() {
    try {
        document.getElementById('loadingSpinner').style.display = 'flex';

        // 單一請求獲取所有初始化資料
        const res = await fetch(`${SCRIPT_URL}?action=getInitialData`);
        const data = await res.json();

        // 賦值給全域變數
        allStudents = data.students || [];
        allClasses = data.classes || [];
        pendingApprovals = data.pendingApprovals || [];

        // 處理繳費通知（過濾出未處理的記錄）
        paymentNotifications = (data.paymentRecords || [])
            .filter(p => !p.processed)
            .map(p => ({
                studentName: p.studentName,
                className: p.className,
                paymentDate: p.paymentDate,
                time: p.time,
                imageUrl: p.imageUrl
            }));

        // 處理試堂通知（未付費或未來試堂）
        trialNotifications = (data.trialStudents || [])
            .filter(t => !t.paid || t.date >= getTodayUTC8());

        // 計算新學生待繳費提醒
        const paidStudentNames = new Set((data.paymentRecords || []).map(p => p.studentName));
        newStudentNotifications = allStudents
            .filter(s => s.flags === 'new' && !paidStudentNames.has(s.name))
            .map(s => ({ name: s.name, className: s.class }));

        // 只更新通知欄
        renderNotificationBody();

        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';

        applyRoleRestrictions();
    } catch (error) {
        console.error(error);
        document.getElementById('loadingSpinner').innerHTML = `
            <p style="color: #c53030;">載入失敗，請重新整理頁面或聯繫管理員。</p>
            <button class="btn btn-primary" onclick="location.reload()">重新整理</button>
        `;
    }
}

    // ---------- 權限控制 ----------
function applyRoleRestrictions() {
    const role = currentUser.role;
    const isAdmin = role === 'admin';
    const isCoach = role === 'coach';
    const isAssistant = role === 'assistant';

    // 繳費憑證上傳：管理員與教練
    document.getElementById('btnPaymentUpload').style.display = (isAdmin || isCoach) ? 'block' : 'none';
    // 班級管理：僅管理員
    document.getElementById('btnClassManage').style.display = isAdmin ? 'block' : 'none';
    // 用戶管理：僅管理員
    document.getElementById('btnUserManage').style.display = isAdmin ? 'block' : 'none';
    // 試堂管理：管理員與教練可見
    document.getElementById('btnTrial').style.display = (isAdmin || isCoach) ? 'block' : 'none';
    // 新增/扣課、新增學生、代請假：管理員與教練可見
    document.getElementById('btnAddClasses').style.display = (isAdmin || isCoach) ? 'block' : 'none';
    document.getElementById('btnAddStudent').style.display = (isAdmin || isCoach) ? 'block' : 'none';
    document.getElementById('btnCoachLeave').style.display = (isAdmin || isCoach) ? 'block' : 'none';
    // 學生資訊：管理員與教練可見
    document.getElementById('btnClear').style.display = (isAdmin || isCoach) ? 'block' : 'none';
    // 以下所有人可見
    document.getElementById('btnAttendance').style.display = 'block';
    document.getElementById('btnRental').style.display = 'block';
    document.getElementById('btnPhoto').style.display = 'block';

    // 試堂新增表單僅管理員可見
    document.getElementById('trialAddForm').style.display = isAdmin ? 'flex' : 'none';
}

    // ---------- 區塊切換 ----------
// ---------- 區塊切換（顯示載入中） ----------
async function showSection(sectionId) {
    if (!currentUser) return;

    const role = currentUser.role;
    const isAdmin = role === 'admin';
    const isCoach = role === 'coach';
    const isAssistant = role === 'assistant';

    if (!isAdmin && !isCoach) {
        if (sectionId === 'clear') {
            showError('您沒有權限查看學生資訊');
            return;
        }
    }
    if (!isAdmin) {
        if (sectionId === 'userManage' || sectionId === 'classManage') {
            showError('您沒有權限使用此功能');
            return;
        }
    }

    showLoadingSpinner('載入中，請稍後...');

    try {
        const sections = ['attendance','rental','trial','addClasses','addStudent','classManage','clear','coachLeave','userManage'];
        sections.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = id === sectionId ? 'block' : 'none';
        });

        if (sectionId === 'trial') {
            await loadTrialList();
            scrollToSection('trial');
        } else if (sectionId === 'userManage' && isAdmin) {
            selectedClasses.clear();
            renderClassSelection();
            await loadUserList();
            scrollToSection('userManage');
        } else if (sectionId === 'classManage' && isAdmin) {
            await loadClassList();
            scrollToSection('classManage');
        } else if (sectionId === 'clear') {
            renderNoteListByClass();
            scrollToSection('clear');
        } else if (sectionId === 'addClasses') {
            scrollToSection('addClasses');
        } else if (sectionId === 'addStudent') {
            const newStudentSelect = document.getElementById('newStudentClass');
            if (newStudentSelect) {
                newStudentSelect.innerHTML = '<option value="">選擇班級</option>' + 
                    allClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            }
            scrollToSection('addStudent');
        } else if (sectionId === 'attendance') {
            updateAttendanceList();
            scrollToSection('attendance');
            // 補點名提示
            const attendanceDiv = document.getElementById('attendance');
            let hint = document.getElementById('makeupHint');
            if (!hint) {
                hint = document.createElement('div');
                hint.id = 'makeupHint';
                hint.className = 'info-box';
                hint.style.marginBottom = '15px';
                attendanceDiv.insertBefore(hint, attendanceDiv.firstChild);
            }
            if (isMakeupMode) {
                hint.innerHTML = `📅 目前為 <strong>補點名模式</strong>，日期：${makeupDate} 
                    <span style="margin-left:10px;">已選 <span id="selectedCount">${makeupSelectedStudents.size}</span> 位學生</span>
                    <button class="btn-sm" onclick="submitMakeupApproval()" style="margin-left:10px; background:#2563eb; color:white;">提交審批</button>
                    <button class="btn-sm" onclick="exitMakeupMode()" style="margin-left:10px;">退出</button>`;
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        } else if (sectionId === 'rental') {
            updateRentalList();
            scrollToSection('rental');
        } else if (sectionId === 'coachLeave') {
            scrollToSection('coachLeave');
        }
    } catch (error) {
        console.error('載入區塊失敗', error);
        showError('載入失敗，請稍後再試');
    } finally {
        hideLoadingSpinner();
    }
}
    // ---------- 取得所有學生 ----------
    async function fetchAllStudents() {
        const res = await fetch(`${SCRIPT_URL}?action=getAllStudents`);
        const data = await res.json();
        allStudents = data || [];
        return data;
    }

    // ---------- 班級排序 ----------
    function sortClasses(classes) {
        return classes.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
    }

    // ---------- 取得班級列表 ----------
    async function loadClassList() {
        const res = await fetch(`${SCRIPT_URL}?action=getAllClasses`);
        let classes = await res.json();
        classes = sortClasses(classes);
        
        // 根據當前用戶角色過濾班級（非管理員僅顯示授權班級）
        if (currentUser && currentUser.role !== 'admin') {
            const allowed = getAuthorizedClasses();
            if (allowed !== '*') {
                classes = classes.filter(c => allowed.includes(c));
            }
        }
        
        allClasses = classes;
        
        // 更新班級列表顯示（用於班級管理區塊）
        renderClassList(classes);
        
        // 更新新增學生下拉選單
        const newStudentSelect = document.getElementById('newStudentClass');
        if (newStudentSelect) {
            newStudentSelect.innerHTML = '<option value="">選擇班級</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        // 更新用戶管理中的班級選擇器（僅管理員可見，但無害）
        renderClassSelection();
        
        return classes;
    }

function getFilteredStudents() {
    const allowedClasses = getAuthorizedClasses();
    if (allowedClasses === '*') return allStudents;
    return allStudents.filter(s => allowedClasses.includes(s.class));
}

    function renderClassList(classes) {
        const container = document.getElementById('classListContainer');
        if (!container) return;
        let html = '';
        classes.forEach(c => {
            html += `<span class="class-badge">${c} 
                <button onclick="deleteClass('${c}')" style="background:transparent; border:none; color:white; margin-left:8px; cursor:pointer;">✕</button>
            </span>`;
        });
        container.innerHTML = html || '尚無班級，請新增。';
    }

    async function addNewClass() {
        if (currentUser.role !== 'admin') { showError('無權限'); return; }
        const className = document.getElementById('newClassName').value.trim();
        if (!className) return showError('請輸入班級名稱');
        const res = await fetch(`${SCRIPT_URL}?action=addClass&className=${encodeURIComponent(className)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess(result.message);
            document.getElementById('newClassName').value = '';
            loadClassList();
        } else {
            showError(result.message);
        }
    }

    async function deleteClass(className) {
        if (currentUser.role !== 'admin') { showError('無權限'); return; }
        if (!confirm(`確定刪除班級「${className}」？`)) return;
        const res = await fetch(`${SCRIPT_URL}?action=deleteClass&className=${encodeURIComponent(className)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess(result.message);
            loadClassList();
        } else {
            showError(result.message);
        }
    }
async function markMakeupAttendance(name) {
    if (!makeupDate) {
        showError('請先選擇補點名日期');
        return;
    }
    const btn = document.querySelector(`.student-button[data-name="${name}"]`);
    if (btn && (btn.disabled || btn.classList.contains('checked'))) {
        showError('此學生已完成點名');
        return;
    }
    if (btn) {
        btn.disabled = true;
        btn.classList.add('checked');
    }

    try {
        const res = await fetch(`${SCRIPT_URL}?action=markAttendanceMakeup&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}&date=${encodeURIComponent(makeupDate)}`);
        const data = await res.json();
        if (data.success) {
            showSuccess(`${name} 補點名成功！`);
            await fetchAllStudents();
            updateAttendanceList();
        } else {
            showError(data.message || '補點名失敗');
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('checked');
            }
        }
    } catch (err) {
        showError('網路錯誤');
        if (btn) {
            btn.disabled = false;
            btn.classList.remove('checked');
        }
    }
}
       async function submitMakeupApproval() {
    if (makeupSelectedStudents.size === 0) {
        showError('請至少選擇一位學生');
        return;
    }
    if (!makeupDate) {
        showError('日期不存在，請重新進入補點名模式');
        return;
    }

    const lockKey = 'submitMakeupApproval';
    if (processing[lockKey]) {
        showError('正在提交中，請稍後...');
        return;
    }
    processing[lockKey] = true;

    const students = Array.from(makeupSelectedStudents);
    const payload = {
        type: 'makeupAttendance',
        payload: {
            students: students,
            date: makeupDate
        }
    };

    try {
        const res = await fetch(`${SCRIPT_URL}?action=submitApprovalRequest&data=${encodeURIComponent(JSON.stringify(payload))}&requester=${encodeURIComponent(currentUser.username)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess('補點名審批請求已提交，等待管理員批准');
            makeupSelectedStudents.clear();
            exitMakeupMode();
        } else {
            showError(result.error || '提交失敗');
        }
    } catch (err) {
        showError('網路錯誤');
    } finally {
        delete processing[lockKey];
    }
}
    // ---------- 點名（根據權限過濾班級）----------
function toggleMakeupStudent(name) {
    if (makeupSelectedStudents.has(name)) {
        makeupSelectedStudents.delete(name);
    } else {
        makeupSelectedStudents.add(name);
    }
    updateAttendanceList(); // 重新渲染按鈕樣式
}
function updateAttendanceList() {
    const container = document.getElementById('attendanceList');
    if (!container) return;

    const filteredStudents = getFilteredStudents();
    const grouped = {};
    filteredStudents.forEach(s => {
        if (!grouped[s.class]) grouped[s.class] = [];
        grouped[s.class].push(s);
    });

    let html = '';
    for (let className in grouped) {
        html += `<div style="margin-bottom:16px;"><h3>${className}班</h3>`;
        grouped[className].forEach(s => {
            const isCheckedNormal = localStorage.getItem(`attendance_${s.name}`) === 'checked';
            const isSelectedMakeup = makeupSelectedStudents.has(s.name);
            
            let buttonClass = 'student-button';
            let disabled = false;
            let onClick = '';

            if (isMakeupMode) {
                // 補點名模式
                if (isCheckedNormal) {
                    buttonClass += ' checked';
                    disabled = true;
                } else {
                    buttonClass += isSelectedMakeup ? ' selected' : '';
                    onClick = `toggleMakeupStudent('${s.name}')`;
                }
            } else {
                // 一般點名模式
                if (isCheckedNormal) {
                    buttonClass += ' checked';
                    disabled = true;
                }
                onClick = `markAttendance('${s.name}')`;
            }

            let buttonText = s.name;
            if (currentUser.role === 'coach' || currentUser.role === 'admin') {
                const zeroClass = s.remainingClasses <= 0 ? 'zero-class' : '';
                if (zeroClass) buttonClass += ' zero-class';
                buttonText += ` <span class="class-count">${s.remainingClasses}堂</span>`;
            }

            html += `<button class="${buttonClass}" data-name="${s.name}" onclick="${onClick}" ${disabled ? 'disabled' : ''}>${buttonText}</button>`;
        });
        html += '</div>';
    }
    container.innerHTML = html;
}

    async function coachRequestDeleteStudent(name) {
        if (currentUser.role !== 'coach') {
            showError('無權限');
            return;
        }
        
        if (!confirm(`確定要請求刪除學生 ${name} 嗎？此操作需要管理員審批。`)) return;

        const lockKey = `requestDelete_${name}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }
        processing[lockKey] = true;

        try {
            const payload = { name };
            const res = await fetch(`${SCRIPT_URL}?action=submitApprovalRequest&data=${encodeURIComponent(JSON.stringify({ type: 'deleteStudent', payload }))}&requester=${encodeURIComponent(currentUser.username)}`);
            const result = await res.json();
            if (result.success) {
                showSuccess('刪除請求已提交，等待管理員審批');
            } else {
                showError(result.error || '提交失敗');
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            delete processing[lockKey];
        }
    }

    async function markAttendance(name) {
        if (processing[`attendance_${name}`]) {
            showError('正在處理中，請稍後...');
            return;
        }
        const btn = document.querySelector(`.student-button[data-name="${name}"]`);
        if (btn && (btn.disabled || btn.classList.contains('checked'))) {
            showError('此學生已完成點名');
            return;
        }
        if (btn) {
            btn.disabled = true;
            btn.classList.add('checked');
            localStorage.setItem(`attendance_${name}`, 'checked');
        }
        processing[`attendance_${name}`] = true;

        try {
            const res = await fetch(`${SCRIPT_URL}?action=markAttendance&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
            const data = await res.json();
            if (data.success) {
                showSuccess(`${name} 點名成功！`);
                await fetchAllStudents();
                updateAttendanceList();
                renderNoteListByClass();
            } else {
                showError(data.message || '點名失敗');
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('checked');
                    localStorage.removeItem(`attendance_${name}`);
                }
            }
        } catch (err) {
            showError('網路錯誤，點名失敗');
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('checked');
                localStorage.removeItem(`attendance_${name}`);
            }
        } finally {
            delete processing[`attendance_${name}`];
        }
    }

function resetAttendance() {
    document.querySelectorAll('.student-button.checked').forEach(b => {
        b.classList.remove('checked');
        b.disabled = false;
    });
    if (!isMakeupMode) {
        allStudents.forEach(s => localStorage.removeItem(`attendance_${s.name}`));
    }
    showSuccess('點名狀態已重置');
}

function exitMakeupMode() {
    isMakeupMode = false;
    makeupDate = '';
    makeupSelectedStudents.clear();
    showSection('attendance');
}

function openMakeupDateModal() {
    // 預設為今天
    const today = getTodayUTC8();
    document.getElementById('makeupDateInput').value = today;
    document.getElementById('makeupDateModal').style.display = 'flex';
}

function closeMakeupDateModal() {
    document.getElementById('makeupDateModal').style.display = 'none';
}

function confirmMakeupDate() {
    const date = document.getElementById('makeupDateInput').value;
    if (!date) {
        showError('請選擇日期');
        return;
    }
    closeMakeupDateModal();

    // 顯示星期幾
    const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
    const d = new Date(date + 'T00:00:00');
    const weekday = weekdays[d.getDay()];
    const confirmMsg = `你確定要補點名日期 ${date} (${weekday}) 的點名嗎？`;

    if (!confirm(confirmMsg)) return;

    // 進入補點名模式
    isMakeupMode = true;
    makeupDate = date;
    showSection('attendance');
}
    // ---------- 租借裝備（根據權限過濾班級）----------
    function updateRentalList() {
        const container = document.getElementById('rentalList');
        if (!container) return;

        const filteredStudents = getFilteredStudents();
        const grouped = {};
        filteredStudents.forEach(s => {
            if (!grouped[s.class]) grouped[s.class] = [];
            grouped[s.class].push(s);
        });

        let html = '';
        for (let className in grouped) {
            html += `<div style="margin-bottom:16px;"><h3>${className}班</h3>`;
            grouped[className].forEach(s => {
                html += `<button class="rental-button" data-name="${s.name}" onclick="addRental('${s.name}')">${s.name} (${s.rentalCount}次)</button>`;
            });
            html += '</div>';
        }
        container.innerHTML = html;
    }

    async function addRental(name) {
        if (processing[`rental_${name}`]) {
            showError('正在處理中，請稍後...');
            return;
        }
        const btn = document.querySelector(`.rental-button[data-name="${name}"]`);
        if (btn) {
            btn.disabled = true;
            btn.textContent = `${name} (處理中)`;
        }
        processing[`rental_${name}`] = true;

        try {
            const res = await fetch(`${SCRIPT_URL}?action=addRental&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
            const data = await res.json();
            if (data.success) {
                showSuccess(`${name} 租借+1，總次數 ${data.rentals}`);
                await fetchAllStudents();
                updateRentalList();
                renderNoteListByClass();
            } else {
                showError(data.error || '租借失敗');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = `${name} (${allStudents.find(s => s.name === name)?.rentalCount || 0}次)`;
                }
            }
        } catch (err) {
            showError('網路錯誤');
            if (btn) {
                btn.disabled = false;
                btn.textContent = `${name} (${allStudents.find(s => s.name === name)?.rentalCount || 0}次)`;
            }
        } finally {
            delete processing[`rental_${name}`];
        }
    }

    // ---------- 取得當前用戶允許的班級陣列（'*' 表示全部）----------
    function getAuthorizedClasses() {
        if (!currentUser) return [];
        if (currentUser.authorizedClasses === '*') return '*';
        return currentUser.authorizedClasses || [];
    }

    // ---------- 輔助：取得 UTC+8 今天日期 ----------
    function getTodayUTC8() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ---------- 試堂通知 ----------
    async function loadTrialNotifications() {
        const res = await fetch(`${SCRIPT_URL}?action=getTrialStudents`);
        const trials = await res.json();
        const today = getTodayUTC8();
        trialNotifications = trials.filter(t => {
            if (!t.paid) return true;
            else return t.date >= today; // 未來試堂且未付費
        });
        renderNotificationBody();
    }

    // ---------- 繳費通知 ----------
    async function loadPaymentNotifications() {
        console.log('loadPaymentNotifications 開始');
        const res = await fetch(`${SCRIPT_URL}?action=getPaymentRecords`);
        const payments = await res.json();
        console.log('從後端獲取的繳費記錄 (原始):', JSON.stringify(payments, null, 2));

        // 待續費提醒：已繳費且未處理的記錄
        paymentNotifications = payments.filter(p => !p.processed).map(p => ({
            studentName: p.studentName,
            className: p.className,
            paymentDate: p.paymentDate,
            time: p.time,
            imageUrl: p.imageUrl
        }));
        console.log('過濾後的 paymentNotifications:', JSON.stringify(paymentNotifications, null, 2));

        // 新學生待繳費提醒：僅標記為 'new' 且尚未有繳費記錄的學生
        const paidStudentNames = new Set(payments.map(p => p.studentName));
        newStudentNotifications = allStudents
            .filter(s => s.flags === 'new' && !paidStudentNames.has(s.name))
            .map(s => ({ name: s.name, className: s.class }));
        console.log('newStudentNotifications:', newStudentNotifications);

        renderNotificationBody();
    }

    // ---------- 待審批請求 ----------
    async function loadPendingApprovals() {
        if (currentUser.role !== 'admin') return;
        const res = await fetch(`${SCRIPT_URL}?action=getPendingApprovals`);
        const data = await res.json();
        pendingApprovals = data;
        renderNotificationBody();
    }

    // ---------- 通知欄控制 ----------
    function toggleNotificationBody() {
        notificationCollapsed = !notificationCollapsed;
        const body = document.getElementById('notificationBody');
        const header = document.getElementById('notificationHeader');
        if (notificationCollapsed) {
            body.classList.add('collapsed');
            header.classList.add('collapsed');
        } else {
            body.classList.remove('collapsed');
            header.classList.remove('collapsed');
        }
    }

    // ---------- 渲染通知欄 ----------
function renderNotificationBody() {
    const body = document.getElementById('notificationBody');
    const countSpan = document.getElementById('notificationCount');
    if (!body) return;

    let total = 0;
    let html = '';

    // 試堂提醒（所有人都可見）
    trialNotifications.forEach(t => {
        total++;
        html += `<div class="notification-item">
            <span class="type-tag">試堂</span>
            <div class="content">
                <strong>${t.name}</strong> - ${t.date} ${t.rentEquipment ? '🛞' : ''} ${t.paid ? '✅已付' : '❌未付'}
                ${t.note ? `<br><span style="font-size:0.8rem; color:#666;">📝 ${t.note}</span>` : ''}
            </div>
            <div class="actions">`;
        if (currentUser.role === 'admin') {
            if (!t.paid) {
                html += `<button class="btn-sm" onclick="markTrialPaid('${t.name}', '${t.date}')">💰標記已付</button>`;
            }
            html += `<button class="btn-sm" onclick="editTrialDate('${t.name}', '${t.date}')">📅改期</button>`;
        }
        html += `</div></div>`;
    });

    // 待續費提醒（管理員和教練可見）
    if (currentUser.role === 'admin' || currentUser.role === 'coach') {
        paymentNotifications.forEach(p => {
            total++;
            html += `<div class="notification-item">
                <span class="type-tag">待續費</span>
                <div class="content">${p.studentName} 已上傳繳費憑證，請管理員點擊續費</div>
                <div class="actions">`;
            if (currentUser.role === 'admin') {
                html += `<button class="btn-sm" onclick="quickRenew('${p.studentName}', '${p.className}')">💰續費按此</button>`;
            } else {
                html += `<span style="color:#718096;">等待管理員處理</span>`;
            }
            html += `</div></div>`;
        });
    }

    // 新學生待繳費提醒（僅管理員）
    if (currentUser.role === 'admin') {
        newStudentNotifications.forEach(n => {
            total++;
            html += `<div class="notification-item">
                <span class="type-tag">新學生</span>
                <div class="content">${n.name} 尚未上傳繳費憑證</div>
                <div class="actions">
                   <button class="btn-sm" onclick="uploadPaymentForNewStudent('${n.name}', '${n.className}')">💰上傳繳費</button>
                </div>
            </div>`;
        });
    }

    // ----- 審批請求區塊 -----
    if (currentUser.role === 'admin') {
        // 管理員：看到所有待審批請求，並可批准/拒絕
        pendingApprovals.forEach(req => {
            total++;
            let content = '';
            if (req.type === 'addClasses') {
                content = `${req.requester} 請求為 ${req.data.name} 增減課堂 (${req.data.classesChange}堂)`;
            } else if (req.type === 'addStudent') {
                content = `${req.requester} 請求新增學生 ${req.data.name}`;
            } else if (req.type === 'deleteStudent') {
                content = `${req.requester} 請求刪除學生 ${req.data.name}`;
            } else if (req.type === 'makeupAttendance') {
                const studentList = req.data.students.join('、');
                content = `${req.requester} 請求為 ${studentList} 補點名 (日期：${req.data.date})`;
            }
            html += `<div class="notification-item">
                <span class="type-tag">審批</span>
                <div class="content">${content}</div>
                <div class="actions">
                    <button class="btn-sm" onclick="approveRequest('${req.id}')">✅批准</button>
                    <button class="btn-sm" onclick="rejectRequest('${req.id}')">❌拒絕</button>
                </div>
            </div>`;
        });
    } else if (currentUser.role === 'coach') {
        // 教練：看到所有補點名請求（需檢查授權班級）以及自己提交的其他請求（只顯示狀態）
        const coachRequests = pendingApprovals.filter(req => {
            return req.type === 'makeupAttendance' || req.requester === currentUser.username;
        });
        coachRequests.forEach(req => {
            total++;
            let content = '';
            let actions = '';
            if (req.type === 'makeupAttendance') {
                const studentList = req.data.students.join('、');
                if (req.requester === currentUser.username) {
                    // 自己提交的補點名
                    content = `您請求為 ${studentList} 補點名 (日期：${req.data.date}) - 審批中`;
                    actions = `<span style="color:#718096;">等待管理員審批</span>`;
                } else {
                    // 他人的補點名（需要教練批准），但需要檢查授權班級
                    const authClasses = currentUser.authorizedClasses;
                    // 過濾出請求中哪些學生屬於教練授權班級
                    const authorizedStudents = [];
                    const unauthorizedStudents = [];
                    req.data.students.forEach(sName => {
                        const student = allStudents.find(s => s.name === sName);
                        if (!student) {
                            unauthorizedStudents.push(sName);
                        } else {
                            if (authClasses === '*' || authClasses.includes(student.class)) {
                                authorizedStudents.push(sName);
                            } else {
                                unauthorizedStudents.push(sName);
                            }
                        }
                    });

                    if (authorizedStudents.length === 0) {
                        // 沒有一個學生是授權班級的，不顯示此請求
                        return; // 跳過此請求
                    }

                    // 構建內容，顯示授權學生和未授權學生
                    content = `${req.requester} 請求為 `;
                    if (authorizedStudents.length > 0) {
                        content += `${authorizedStudents.join('、')}`;
                        if (unauthorizedStudents.length > 0) {
                            content += ` 及其他學生（不在您授權範圍）`;
                        }
                    }
                    content += ` 補點名 (日期：${req.data.date})`;

                    if (unauthorizedStudents.length > 0) {
                        actions = `<span style="color:#b91c1c;">部分學生不在授權範圍，無法批准</span>`;
                    } else {
                        actions = `
                            <button class="btn-sm" onclick="approveRequest('${req.id}')">✅批准</button>
                            <button class="btn-sm" onclick="rejectRequest('${req.id}')">❌拒絕</button>
                        `;
                    }
                }
            } else if (req.type === 'addClasses') {
                content = `您請求為 ${req.data.name} 增減課堂 (${req.data.classesChange}堂) - 審批中`;
                actions = `<span style="color:#718096;">等待管理員審批</span>`;
            } else if (req.type === 'addStudent') {
                content = `您請求新增學生 ${req.data.name} - 審批中`;
                actions = `<span style="color:#718096;">等待管理員審批</span>`;
            } else if (req.type === 'deleteStudent') {
                content = `您請求刪除學生 ${req.data.name} - 審批中`;
                actions = `<span style="color:#718096;">等待管理員審批</span>`;
            }
            html += `<div class="notification-item">
                <span class="type-tag">審批</span>
                <div class="content">${content}</div>
                <div class="actions">${actions}</div>
            </div>`;
        });
    } else if (currentUser.role === 'assistant') {
        // 助教：只看到自己提交的請求，無批准按鈕
        const myRequests = pendingApprovals.filter(req => req.requester === currentUser.username);
        myRequests.forEach(req => {
            total++;
            let content = '';
            if (req.type === 'addClasses') {
                content = `您請求為 ${req.data.name} 增減課堂 (${req.data.classesChange}堂) - 審批中`;
            } else if (req.type === 'addStudent') {
                content = `您請求新增學生 ${req.data.name} - 審批中`;
            } else if (req.type === 'deleteStudent') {
                content = `您請求刪除學生 ${req.data.name} - 審批中`;
            } else if (req.type === 'makeupAttendance') {
                const studentList = req.data.students.join('、');
                content = `您請求為 ${studentList} 補點名 (日期：${req.data.date}) - 審批中`;
            }
            html += `<div class="notification-item">
                <span class="type-tag">審批中</span>
                <div class="content">${content}</div>
                <div class="actions">
                    <span style="color:#718096;">等待審批</span>
                </div>
            </div>`;
        });
    }

    if (total === 0) {
        html = '<div class="notification-item">目前沒有待辦通知</div>';
    }

    body.innerHTML = html;
    countSpan.textContent = total;
}

    // ---------- 快速續費 ----------
async function quickRenew(name, className) {
    // 僅允許管理員執行續費
    if (currentUser.role !== 'admin') {
        showError('只有管理員可以執行續費操作');
        return;
    }
        const lockKey = `renew_${name}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }
        processing[lockKey] = true;
        showLoadingSpinner('續費處理中...');

        try {
            let res = await fetch(`${SCRIPT_URL}?action=clearLeaveCount&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
            let result = await res.json();
            if (!result.success) throw new Error(result.error || '清零請假失敗');

            res = await fetch(`${SCRIPT_URL}?action=clearRental&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
            result = await res.json();
            if (!result.success) throw new Error(result.error || '清零租借失敗');

            const payload = { name, class: className, classesChange: 10, reason: '已續費' };
            res = await fetch(`${SCRIPT_URL}?action=addClasses&data=${encodeURIComponent(JSON.stringify(payload))}&operator=${encodeURIComponent(currentUser.username)}`);
            result = await res.json();
            if (!result.success) throw new Error(result.error || '增加課堂失敗');

            console.log('當前 paymentNotifications:', paymentNotifications);
            const pendingForStudent = paymentNotifications.filter(p => p.studentName === name);
            console.log('待標記的繳費記錄 (pendingForStudent):', JSON.stringify(pendingForStudent, null, 2));

            for (let p of pendingForStudent) {
                console.log('處理單筆記錄:', p);
                if (!p.time || !p.studentName) {
                    console.error('❌ 記錄缺少必要屬性', p);
                    showError('繳費記錄資料不完整，無法自動標記');
                    continue;
                }
                console.log(`標記繳費記錄：time=${p.time}, studentName=${p.studentName}, 類型: ${typeof p.time}`);
                const markRes = await fetch(`${SCRIPT_URL}?action=markPaymentProcessed&time=${encodeURIComponent(p.time)}&studentName=${encodeURIComponent(p.studentName)}`);
                const markResult = await markRes.json();
                console.log('標記結果:', markResult);
                if (!markResult.success) {
                    console.error('標記失敗：', markResult.error);
                    showError(`標記失敗：${markResult.error}`);
                } else {
                    console.log('✅ 標記成功');
                }
            }

            showSuccess(`${name} 續費成功！已增加10堂課，請假/租借次數歸零。`);

            await fetchAllStudents();
            await loadPaymentNotifications();
            renderNoteListByClass();
            updateRentalList();

        } catch (err) {
            showError(err.message);
        } finally {
            hideLoadingSpinner();
            delete processing[lockKey];
        }
    }

    // 為新學生上傳繳費憑證（管理員專用）
// 修正 uploadPaymentForNewStudent（接收兩個參數）
function uploadPaymentForNewStudent(name, className) {
    // 儲存待處理的新學生資訊
    pendingNewStudent = { name, className };
    // 觸發檔案選擇
    document.getElementById('paymentUploadInput').click();
}

    // ---------- 試堂管理 ----------
    async function loadTrialList() {
        const res = await fetch(`${SCRIPT_URL}?action=getTrialStudents`);
        const trials = await res.json();
        const container = document.getElementById('trialList');
        let html = '';
        trials.forEach(t => {
            html += `<div class="student-row">
                <div class="details">
                    <strong>${t.name}</strong> ${t.date} ${t.rentEquipment ? '🛞' : ''} ${t.paid ? '✅已付' : '❌未付'}
                    ${t.note ? `<div class="note">📝 ${t.note}</div>` : ''}
                </div>`;
            html += `<div class="actions">`;
            if (currentUser.role === 'admin') {
                html += `<button class="btn-sm" onclick="editTrialDate('${t.name}', '${t.date}')">📅改期</button>`;
                if (!t.paid) {
                    html += `<button class="btn-sm" onclick="markTrialPaid('${t.name}', '${t.date}')">💰收費</button>`;
                }
                html += `<button class="btn-sm" onclick="openNoteModalForTrial('${t.name}', '${t.date}')">✏️備註</button>
                         <button class="btn-sm" onclick="confirmDeleteTrial('${t.name}', '${t.date}')">❌刪除</button>`;
            } else {
                html += `<span style="color:#718096;">僅管理員可操作</span>`;
            }
            html += `</div></div>`;
        });
        container.innerHTML = html || '無試堂學生';
    }

    window.editTrialDate = function(name, originalDate) {
        if (currentUser.role !== 'admin') { showError('無權限'); return; }
        const hiddenPicker = document.getElementById('hiddenDatePicker');
        hiddenPicker.value = originalDate;
        hiddenPicker.style.pointerEvents = 'auto';
        hiddenPicker.style.opacity = '0.01';
        hiddenPicker.focus();
        setTimeout(() => {
            if (hiddenPicker.showPicker) {
                hiddenPicker.showPicker();
            } else {
                hiddenPicker.click();
            }
        }, 200);

        const changeHandler = async function() {
            const newDate = this.value;
            this.removeEventListener('change', changeHandler);
            hiddenPicker.style.pointerEvents = 'none';
            hiddenPicker.style.opacity = '0';
            if (!newDate) return;
            const updates = { date: newDate };
            const res = await fetch(`${SCRIPT_URL}?action=updateTrialStudent&name=${encodeURIComponent(name)}&date=${encodeURIComponent(originalDate)}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
            const result = await res.json();
            if (result.success) {
                showSuccess('日期已更新');
                await loadTrialNotifications();
                await loadTrialList();
            } else {
                showError(result.error);
            }
        };
        hiddenPicker.addEventListener('change', changeHandler);
    };

    window.openNoteModalForTrial = function(name, date) {
        currentNoteTarget = { type: 'trial', name, date };
        document.getElementById('modalNoteInput').value = '';
        document.getElementById('noteModal').style.display = 'flex';
    };

    window.confirmDeleteTrial = function(name, date) {
        if (currentUser.role !== 'admin') { showError('無權限'); return; }
        const lockKey = `deleteTrial_${name}_${date}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }

        currentConfirmCallback = async () => {
            processing[lockKey] = true;

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.querySelector('#confirmModal .cancel');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '刪除中...';
            cancelBtn.disabled = true;

            try {
                const res = await fetch(`${SCRIPT_URL}?action=deleteTrialStudent&name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess('刪除成功');
                    await loadTrialNotifications();
                    await loadTrialList();
                } else {
                    showError(result.error || '刪除失敗');
                }
            } catch (err) {
                showError('網路錯誤');
            } finally {
                delete processing[lockKey];
                confirmBtn.disabled = false;
                confirmBtn.textContent = '確定';
                cancelBtn.disabled = false;
                closeConfirmModal();
            }
        };

        document.getElementById('confirmTitle').textContent = '確認刪除';
        document.getElementById('confirmMessage').textContent = `確定要刪除 ${name} 於 ${date} 的試堂記錄嗎？`;
        document.getElementById('confirmBtn').onclick = currentConfirmCallback;
        document.getElementById('confirmModal').style.display = 'flex';
    };

    window.markTrialPaid = async function(name, date) {
        if (currentUser.role !== 'admin') { showError('無權限'); return; }
        const res = await fetch(`${SCRIPT_URL}?action=markTrialPaid&name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess('已標記收費');
            await loadTrialNotifications();
            await loadTrialList();
        } else {
            showError(result.error || '標記失敗');
        }
    };

    async function addTrial() {
        if (currentUser.role !== 'admin') { showError('無權限'); return; }
        if (processing.addTrial) {
            showError('正在新增中，請稍後...');
            return;
        }
        const btn = document.querySelector('#trial .btn-indigo');
        if (btn) {
            btn.disabled = true;
            btn.textContent = '新增中...';
        }
        processing.addTrial = true;

        try {
            const data = {
                name: document.getElementById('trialName').value,
                date: document.getElementById('trialDate').value,
                rentEquipment: document.getElementById('trialRent').value === 'true',
                paid: document.getElementById('trialPaid').value === 'true',
                note: document.getElementById('trialNote').value
            };
            if (!data.name || !data.date) return showError('姓名與日期必填');
            const res = await fetch(`${SCRIPT_URL}?action=addTrialStudent&data=${encodeURIComponent(JSON.stringify(data))}`);
            const result = await res.json();
            if (result.success) {
                showSuccess('新增成功');
                document.getElementById('trialName').value = '';
                document.getElementById('trialDate').value = '';
                document.getElementById('trialNote').value = '';
                await loadTrialNotifications();
                await loadTrialList();
            } else {
                showError(result.error || '新增失敗');
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = '新增試堂學生';
            }
            delete processing.addTrial;
        }
    }

    // ---------- 新增/扣課 ----------
    const searchInput = document.getElementById('searchStudentInput');
    const dropdown = document.getElementById('studentDropdown');
    if (searchInput) {
searchInput.addEventListener('input', function(e) {
    const kw = e.target.value.trim().toLowerCase();
    if (kw.length < 1) { dropdown.style.display = 'none'; return; }
    const filtered = getFilteredStudents().filter(s => s.name.toLowerCase().includes(kw));  
    if (filtered.length === 0) { dropdown.style.display = 'none'; return; }
    let html = '';
    filtered.forEach(s => html += `<div class="dropdown-item" onclick="selectStudent('${s.name}', '${s.class}')">${s.name} (${s.class}) 剩${s.remainingClasses}堂</div>`);
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
});
        document.addEventListener('click', e => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none';
        });
    }
    window.selectStudent = function(name, className) {
        document.getElementById('searchStudentInput').value = name;
        document.getElementById('selectedClass').value = className;
        dropdown.style.display = 'none';
    };

    async function submitAddClasses() {
        if (currentUser.role !== 'admin' && currentUser.role !== 'coach') { showError('無權限'); return; }
        if (processing.addClasses) {
            showError('正在處理中...');
            return;
        }
        const btn = document.querySelector('#addClasses .btn-success');
        if (btn) {
            btn.disabled = true;
            btn.textContent = '提交中...';
        }
        processing.addClasses = true;

        try {
            const name = document.getElementById('searchStudentInput').value.trim();
            const className = document.getElementById('selectedClass').value;
            const delta = parseInt(document.getElementById('addClassDelta').value);
            const reason = document.getElementById('addClassReason').value.trim() || '教練調整';
            if (!name || !className || isNaN(delta)) {
                showError('請完成所有欄位');
                return;
            }
            const payload = { name, class: className, classesChange: delta, reason };

            if (currentUser.role === 'admin') {
                const res = await fetch(`${SCRIPT_URL}?action=addClasses&data=${encodeURIComponent(JSON.stringify(payload))}&operator=${encodeURIComponent(currentUser.username)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess(result.message);
                    document.getElementById('searchStudentInput').value = '';
                    document.getElementById('selectedClass').value = '';
                    document.getElementById('addClassDelta').value = '10';
                    document.getElementById('addClassReason').value = '';
                    await fetchAllStudents();
                    updateAttendanceList();
                    updateRentalList();
                    renderNoteListByClass();
                } else {
                    showError(result.message);
                }
            } else {
                const res = await fetch(`${SCRIPT_URL}?action=submitApprovalRequest&data=${encodeURIComponent(JSON.stringify({ type: 'addClasses', payload }))}&requester=${encodeURIComponent(currentUser.username)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess('請求已提交，等待管理員審批');
                    document.getElementById('searchStudentInput').value = '';
                    document.getElementById('selectedClass').value = '';
                    document.getElementById('addClassDelta').value = '10';
                    document.getElementById('addClassReason').value = '';
                } else {
                    showError(result.error);
                }
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = '提交審批';
            }
            delete processing.addClasses;
        }
    }

    // ---------- 新增學生 ----------
    async function submitAddStudent() {
        if (currentUser.role !== 'admin' && currentUser.role !== 'coach') { showError('無權限'); return; }
        if (processing.addStudent) {
            showError('正在新增中...');
            return;
        }
        const btn = document.querySelector('#addStudent .btn-indigo');
        if (btn) {
            btn.disabled = true;
            btn.textContent = '提交中...';
        }
        processing.addStudent = true;

        try {
            const name = document.getElementById('newStudentName').value.trim();
            const className = document.getElementById('newStudentClass').value;
            const note = document.getElementById('newStudentNote').value.trim();
            if (!name || !className) {
                showError('請填寫姓名與班級');
                return;
            }
            const payload = { name, class: className, classes: 10, note };

            if (currentUser.role === 'admin') {
                const res = await fetch(`${SCRIPT_URL}?action=addStudent&data=${encodeURIComponent(JSON.stringify(payload))}&operator=${encodeURIComponent(currentUser.username)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess(`學生 ${name} 新增成功！已獲得 10 堂課。`);
                    newStudentNotifications.push({ name: name, time: new Date().toISOString() });
                    renderNotificationBody();
                    document.getElementById('newStudentName').value = '';
                    document.getElementById('newStudentClass').value = '';
                    document.getElementById('newStudentNote').value = '';
                    await fetchAllStudents();
                    updateAttendanceList();
                    updateRentalList();
                    renderNoteListByClass();
                } else {
                    showError(result.message || '新增失敗');
                }
            } else {
                const res = await fetch(`${SCRIPT_URL}?action=submitApprovalRequest&data=${encodeURIComponent(JSON.stringify({ type: 'addStudent', payload }))}&requester=${encodeURIComponent(currentUser.username)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess('請求已提交，等待管理員審批');
                    document.getElementById('newStudentName').value = '';
                    document.getElementById('newStudentClass').value = '';
                    document.getElementById('newStudentNote').value = '';
                } else {
                    showError(result.error);
                }
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = '提交審批';
            }
            delete processing.addStudent;
        }
    }

    // ---------- 學生資訊列表 ----------
    function renderNoteListByClass() {
        const container = document.getElementById('noteListByClass');
        if (!container) return;

        const filteredStudents = getFilteredStudents();
        const grouped = {};
        filteredStudents.forEach(s => {
            if (!grouped[s.class]) grouped[s.class] = [];
            grouped[s.class].push(s);
        });

        let html = '';
        const sortedClasses = sortClasses(Object.keys(grouped));
        sortedClasses.forEach(className => {
            const collapsed = classCollapsed[className] ? 'collapsed' : '';
            const icon = classCollapsed[className] ? '▶' : '▼';
            html += `<div class="class-header ${collapsed}" onclick="toggleClass('${className}')">
                <span class="toggle-icon">${icon}</span>
                <h3>${className}班</h3>
            </div>`;
            html += `<div class="class-students ${collapsed}" id="class-${className}">`;
            grouped[className].forEach(s => {
                const icons = [];
                if (currentUser.role === 'admin') {
                    if (s.remainingClasses <= 0) icons.push('🔴');
                }
                if (s.leaveCount >= 2) icons.push('🟡');
                const iconsHtml = icons.length ? `<span class="icons">${icons.join(' ')}</span>` : '';

                html += `<div class="student-row">
                    <div class="details">
                        <div class="name-with-icons">
                            ${iconsHtml}
                            <strong>${s.name}</strong>
                        </div>
                        <div class="stats">`;
                if (currentUser.role === 'admin' || currentUser.role === 'coach') {
                    html += `<span class="class-badge-stat">剩 ${s.remainingClasses} 堂</span>`;
                }
                html += `<span class="leave-badge">請假 ${s.leaveCount}</span>
                            <span class="rental-badge">租借 ${s.rentalCount}</span>
                        </div>`;
                if (currentUser.role === 'admin' || currentUser.role === 'coach') {
                    html += s.note ? `<div class="note">📝 ${s.note}</div>` : '<div class="note" style="color:#a0aec0;">無備註</div>';
                }
                html += `</div>`;
                if (currentUser.role === 'admin' || currentUser.role === 'coach') {
                    html += `<div class="actions">`;
                    if (currentUser.role === 'admin') {
                        html += `<button class="btn-sm" onclick="openNoteModalForStudent('${s.name}')">✏️編輯備註</button>`;
                        html += `<button class="btn-sm" onclick="clearStudentLeave('${s.name}', event)">🧹清零請假</button>`;
                        html += `<button class="btn-sm" onclick="clearStudentRental('${s.name}', event)">🛞清零租借</button>`;
                        html += `<button class="btn-sm" onclick="quickRenew('${s.name}', '${s.class}')">💰續費</button>`;
                        html += `<button class="btn-sm" onclick="confirmDeleteStudent('${s.name}')">❌刪除學生</button>`;
                    } else if (currentUser.role === 'coach') {
                        // 教練僅保留刪除（需審批）
                        html += `<button class="btn-sm" onclick="coachRequestDeleteStudent('${s.name}')">❌請求刪除學生</button>`;
                    }
                    html += `</div>`;
                }
                html += `</div>`;
            });
            html += `</div>`;
        });
        container.innerHTML = html || '無學生資料';
    }

    window.toggleClass = function(className) {
        classCollapsed[className] = !classCollapsed[className];
        renderNoteListByClass();
    };

    window.openNoteModalForStudent = function(name) {
        currentNoteTarget = { type: 'student', name };
        const student = allStudents.find(s => s.name === name);
        document.getElementById('modalNoteInput').value = student?.note || '';
        document.getElementById('noteModal').style.display = 'flex';
    };

    async function saveNote() {
        if (!currentNoteTarget) {
            closeNoteModal();
            return;
        }
        const newNote = document.getElementById('modalNoteInput').value.trim();
        const { type, name, date } = currentNoteTarget;
        const lockKey = `note_${type}_${name}${date ? '_'+date : ''}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }
        processing[lockKey] = true;

        const saveBtn = document.getElementById('saveNoteBtn');
        const cancelBtn = document.querySelector('#noteModal .cancel');
        saveBtn.disabled = true;
        cancelBtn.disabled = true;
        saveBtn.textContent = '儲存中...';

        try {
            if (type === 'student') {
                const updates = { note: newNote };
                const res = await fetch(`${SCRIPT_URL}?action=updateStudentNote&name=${encodeURIComponent(name)}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess('備註已更新');
                    await fetchAllStudents();
                    renderNoteListByClass();
                } else {
                    showError(result.error || '更新失敗');
                }
            } else if (type === 'trial') {
                const updates = { note: newNote };
                const res = await fetch(`${SCRIPT_URL}?action=updateTrialStudent&name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess('備註已更新');
                    await loadTrialNotifications();
                    await loadTrialList();
                } else {
                    showError(result.error || '更新失敗');
                }
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            delete processing[lockKey];
            saveBtn.disabled = false;
            cancelBtn.disabled = false;
            saveBtn.textContent = '儲存';
            closeNoteModal();
        }
    }

    window.clearStudentLeave = function(name, event) {
        const btn = event.currentTarget;
        const lockKey = `clearLeave_${name}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }
        btn.disabled = true;
        processing[lockKey] = true;

        currentConfirmCallback = async () => {
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.querySelector('#confirmModal .cancel');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '處理中...';
            cancelBtn.disabled = true;

            try {
                const res = await fetch(`${SCRIPT_URL}?action=clearLeaveCount&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess(`${name} 請假次數已清零`);
                    await fetchAllStudents();
                    renderNoteListByClass();
                } else {
                    showError(result.error);
                    btn.disabled = false;
                    delete processing[lockKey];
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '確定';
                    cancelBtn.disabled = false;
                    closeConfirmModal();
                    return;
                }
            } catch (err) {
                showError('網路錯誤');
                btn.disabled = false;
                delete processing[lockKey];
                confirmBtn.disabled = false;
                confirmBtn.textContent = '確定';
                cancelBtn.disabled = false;
                closeConfirmModal();
                return;
            }
            closeConfirmModal();
            delete processing[lockKey];
        };

        document.getElementById('confirmTitle').textContent = '確認清零請假';
        document.getElementById('confirmMessage').textContent = `確定將 ${name} 的請假次數歸零？`;
        document.getElementById('confirmBtn').onclick = currentConfirmCallback;
        document.getElementById('confirmModal').style.display = 'flex';
    };

    window.clearStudentRental = function(name, event) {
        const btn = event.currentTarget;
        const lockKey = `clearRental_${name}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }
        btn.disabled = true;
        processing[lockKey] = true;

        currentConfirmCallback = async () => {
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.querySelector('#confirmModal .cancel');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '處理中...';
            cancelBtn.disabled = true;

            try {
                const res = await fetch(`${SCRIPT_URL}?action=clearRental&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
                const result = await res.json();
                if (result.success) {
                    showSuccess(`${name} 租借次數已清零`);
                    await fetchAllStudents();
                    renderNoteListByClass();
                    updateRentalList();
                } else {
                    showError(result.error);
                    btn.disabled = false;
                    delete processing[lockKey];
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '確定';
                    cancelBtn.disabled = false;
                    closeConfirmModal();
                    return;
                }
            } catch (err) {
                showError('網路錯誤');
                btn.disabled = false;
                delete processing[lockKey];
                confirmBtn.disabled = false;
                confirmBtn.textContent = '確定';
                cancelBtn.disabled = false;
                closeConfirmModal();
                return;
            }
            closeConfirmModal();
            delete processing[lockKey];
        };

        document.getElementById('confirmTitle').textContent = '確認清零租借';
        document.getElementById('confirmMessage').textContent = `確定將 ${name} 的租借次數歸零？`;
        document.getElementById('confirmBtn').onclick = currentConfirmCallback;
        document.getElementById('confirmModal').style.display = 'flex';
    };

    window.confirmDeleteStudent = function(name) {
        if (currentUser.role !== 'admin' && currentUser.role !== 'coach') { showError('無權限'); return; }
        const lockKey = `deleteStudent_${name}`;
        if (processing[lockKey]) {
            showError('正在處理中，請稍後...');
            return;
        }

        currentConfirmCallback = async () => {
            closeConfirmModal();

            currentConfirmCallback = async () => {
                processing[lockKey] = true;

                const confirmBtn = document.getElementById('confirmBtn');
                const cancelBtn = document.querySelector('#confirmModal .cancel');
                confirmBtn.disabled = true;
                confirmBtn.textContent = '刪除中...';
                cancelBtn.disabled = true;

                try {
                    const res = await fetch(`${SCRIPT_URL}?action=deleteStudent&name=${encodeURIComponent(name)}`);
                    const result = await res.json();
                    if (result.success) {
                        showSuccess(`${name} 已刪除`);
                        await fetchAllStudents();
                        renderNoteListByClass();
                        updateAttendanceList();
                        updateRentalList();
                    } else {
                        showError(result.error || '刪除失敗');
                    }
                } catch (err) {
                    showError('網路錯誤');
                } finally {
                    delete processing[lockKey];
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '確定';
                    cancelBtn.disabled = false;
                    closeConfirmModal();
                }
            };

            document.getElementById('confirmTitle').textContent = '再次確認';
            document.getElementById('confirmMessage').textContent = `真的要刪除 ${name} 嗎？此操作無法復原，僅能從備份還原。`;
            document.getElementById('confirmBtn').onclick = currentConfirmCallback;
            document.getElementById('confirmModal').style.display = 'flex';
        };

        document.getElementById('confirmTitle').textContent = '確認刪除學生';
        document.getElementById('confirmMessage').textContent = `確定要刪除 ${name}？該操作只能從備份逆轉。`;
        document.getElementById('confirmBtn').onclick = currentConfirmCallback;
        document.getElementById('confirmModal').style.display = 'flex';
    };

    // ---------- 教練代請假 ----------
    const coachSearch = document.getElementById('coachLeaveSearchInput');
    const coachDropdown = document.getElementById('coachLeaveDropdown');
    if (coachSearch) {
coachSearch.addEventListener('input', function(e) {
    const kw = e.target.value.trim().toLowerCase();
    if (kw.length < 1) { coachDropdown.style.display = 'none'; return; }
    const filtered = getFilteredStudents().filter(s => s.name.toLowerCase().includes(kw));  // ← 修改處
    if (filtered.length === 0) { coachDropdown.style.display = 'none'; return; }
    let html = '';
    filtered.forEach(s => html += `<div class="dropdown-item" onclick="selectCoachLeave('${s.name}', '${s.class}')">${s.name} (${s.class}) 請假${s.leaveCount}次</div>`);
    coachDropdown.innerHTML = html;
    coachDropdown.style.display = 'block';
});
        document.addEventListener('click', e => {
            if (!coachSearch.contains(e.target) && !coachDropdown.contains(e.target)) coachDropdown.style.display = 'none';
        });
    }
    window.selectCoachLeave = function(name, className) {
        document.getElementById('coachLeaveSearchInput').value = name;
        document.getElementById('coachLeaveSelectedClass').value = className;
        coachDropdown.style.display = 'none';
    };

    async function submitCoachLeave() {
        if (currentUser.role !== 'admin' && currentUser.role !== 'coach') { showError('無權限'); return; }
        if (processing.coachLeave) {
            showError('正在處理中...');
            return;
        }
        const btn = document.querySelector('#coachLeave .btn-purple');
        if (btn) {
            btn.disabled = true;
            btn.textContent = '處理中...';
        }
        processing.coachLeave = true;

        try {
            const name = document.getElementById('coachLeaveSearchInput').value.trim();
            const className = document.getElementById('coachLeaveSelectedClass').value;
            if (!name || !className) {
                showError('請選擇學生');
                return;
            }
            const student = allStudents.find(s => s.name === name);
            let msg = `確定為 ${name} 提交請假？`;
            if (student && student.leaveCount >= 2) msg += '\n⚠️ 將扣1堂課！';
            if (!confirm(msg)) return;

            const res = await fetch(`${SCRIPT_URL}?action=coachSubmitLeave&name=${encodeURIComponent(name)}&operator=${encodeURIComponent(currentUser.username)}`);
            const result = await res.json();
            if (result.success) {
                showSuccess(`請假成功！請假次數: ${result.leaveCount}，剩餘: ${result.remaining}`);
                await fetchAllStudents();
                updateAttendanceList();
                renderNoteListByClass();
                document.getElementById('coachLeaveSearchInput').value = '';
                document.getElementById('coachLeaveSelectedClass').value = '';
            } else {
                showError(result.error || '請假失敗');
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = '提交請假';
            }
            delete processing.coachLeave;
        }
    }

    // ---------- 班級選擇器函數 ----------
    function renderClassSelection() {
        const container = document.getElementById('classSelectionContainer');
        if (!container) return;
        let html = '';
        allClasses.forEach(className => {
            const isSelected = selectedClasses.has(className);
            html += `<span class="class-badge" style="cursor:pointer; background:${isSelected ? '#48bb78' : '#4299e1'};" onclick="toggleClassSelection('${className}')">${className} ${isSelected ? '✓' : ''}</span>`;
        });
        container.innerHTML = html;
        updateSelectedClassesDisplay();
    }

    function toggleClassSelection(className) {
        if (selectedClasses.has(className)) {
            selectedClasses.delete(className);
        } else {
            selectedClasses.add(className);
        }
        renderClassSelection();
    }

    function clearAllSelectedClasses() {
        selectedClasses.clear();
        renderClassSelection();
    }

    function updateSelectedClassesDisplay() {
        const displaySpan = document.getElementById('selectedClassesDisplay');
        const hiddenInput = document.getElementById('newAuthClasses');
        if (!displaySpan || !hiddenInput) return;
        const classesArray = Array.from(selectedClasses);
        displaySpan.textContent = classesArray.length ? `已選：${classesArray.join(', ')}` : '尚未選取任何班級';
        hiddenInput.value = classesArray.join(',');
    }

    // ---------- 用戶管理函數 ----------
    async function loadUserList() {
        if (currentUser.role !== 'admin') return;
        const res = await fetch(`${SCRIPT_URL}?action=getAllUsers`);
        const users = await res.json();
        const container = document.getElementById('userList');
        let html = '';
        users.forEach(u => {
            let roleName = '助教';
            if (u.role === 'admin') roleName = '管理員';
            else if (u.role === 'coach') roleName = '教練';
            html += `<div class="student-row">
                <div class="details">
                    <strong>${u.username}</strong> (${roleName})<br>
                    <span style="font-size:0.85rem;">班級: ${u.authorizedClasses === '*' ? '全部' : u.authorizedClasses}</span><br>
                    <span style="font-size:0.85rem;">密碼: ${u.password}</span>
                </div>
                <div class="actions">
                    <button class="btn-sm" onclick="openEditUserModal('${u.username}', '${u.password}', '${u.role}', '${u.authorizedClasses}')">✏️編輯</button>
                    <button class="btn-sm" onclick="confirmDeleteUser('${u.username}')">❌刪除</button>
                </div>
            </div>`;
        });
        container.innerHTML = html || '尚無用戶';
    }

    // ---------- 修改密碼 ----------
    function openChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'flex';
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword1').value = '';
        document.getElementById('newPassword2').value = '';
    }

    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
    }

    async function submitChangePassword() {
        const oldPwd = document.getElementById('oldPassword').value.trim();
        const newPwd1 = document.getElementById('newPassword1').value.trim();
        const newPwd2 = document.getElementById('newPassword2').value.trim();

        if (!oldPwd || !newPwd1 || !newPwd2) {
            showError('請填寫所有欄位');
            return;
        }
        if (newPwd1 !== newPwd2) {
            showError('兩次新密碼不一致');
            return;
        }

        const verifyRes = await fetch(`${SCRIPT_URL}?action=verifyUser&username=${encodeURIComponent(currentUser.username)}&password=${encodeURIComponent(oldPwd)}`);
        const verifyData = await verifyRes.json();
        if (!verifyData.success) {
            showError('舊密碼錯誤');
            return;
        }

        const updates = { password: newPwd1 };
        const updateRes = await fetch(`${SCRIPT_URL}?action=updateUser&username=${encodeURIComponent(currentUser.username)}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
        const updateData = await updateRes.json();
        if (updateData.success) {
            showSuccess('密碼修改成功');
            closeChangePasswordModal();
        } else {
            showError(updateData.error || '修改失敗');
        }
    }

    async function addUser() {
        if (currentUser.role !== 'admin') return;
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value.trim();
        const role = document.getElementById('newRole').value;
        
        const classesArray = Array.from(selectedClasses);
        let authClasses = classesArray.join(',');
        if (classesArray.length === allClasses.length) {
            authClasses = '*';
        }

        if (!username || !password) { showError('請填寫用戶名與密碼'); return; }
        
        const addBtn = document.getElementById('addUserBtn');
        const originalText = addBtn.textContent;
        addBtn.disabled = true;
        addBtn.textContent = '新增中...';

        const data = {
            username,
            password,
            role,
            authorizedClasses: authClasses
        };
        try {
            const res = await fetch(`${SCRIPT_URL}?action=addUser&data=${encodeURIComponent(JSON.stringify(data))}`);
            const result = await res.json();
            if (result.success) {
                showSuccess('用戶新增成功');
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '123456';
                selectedClasses.clear();
                renderClassSelection();
                loadUserList();
            } else {
                showError(result.error || '新增失敗');
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            addBtn.disabled = false;
            addBtn.textContent = originalText;
        }
    }

    function openEditUserModal(username, password, role, authClasses) {
        document.getElementById('editUsername').value = username;
        document.getElementById('editPassword').value = '';
        document.getElementById('editRole').value = role;

        selectedClasses.clear();
        if (authClasses === '*') {
            allClasses.forEach(c => selectedClasses.add(c));
        } else {
            authClasses.split(',').forEach(c => {
                if (c.trim()) selectedClasses.add(c.trim());
            });
        }
        renderEditClassSelection();
        document.getElementById('editUserModal').style.display = 'flex';
    }

    function renderEditClassSelection() {
        const container = document.getElementById('editClassSelectionContainer');
        if (!container) return;
        let html = '';
        allClasses.forEach(className => {
            const isSelected = selectedClasses.has(className);
            html += `<span class="class-badge" style="cursor:pointer; background:${isSelected ? '#48bb78' : '#4299e1'};" onclick="toggleEditClassSelection('${className}')">${className} ${isSelected ? '✓' : ''}</span>`;
        });
        container.innerHTML = html;
        updateEditSelectedClassesDisplay();
    }

    function toggleEditClassSelection(className) {
        if (selectedClasses.has(className)) {
            selectedClasses.delete(className);
        } else {
            selectedClasses.add(className);
        }
        renderEditClassSelection();
    }

    function clearEditSelectedClasses() {
        selectedClasses.clear();
        renderEditClassSelection();
    }

    function updateEditSelectedClassesDisplay() {
        const displaySpan = document.getElementById('editSelectedClassesDisplay');
        const hiddenInput = document.getElementById('editAuthClasses');
        if (!displaySpan || !hiddenInput) return;
        const classesArray = Array.from(selectedClasses);
        displaySpan.textContent = classesArray.length ? `已選：${classesArray.join(', ')}` : '尚未選取任何班級';
        hiddenInput.value = classesArray.join(',');
    }

    async function saveUserEdit() {
        const username = document.getElementById('editUsername').value;
        const password = document.getElementById('editPassword').value.trim();
        const role = document.getElementById('editRole').value;
        
        const classesArray = Array.from(selectedClasses);
        let authClasses = classesArray.join(',');
        if (classesArray.length === allClasses.length) {
            authClasses = '*';
        }

        const updates = {};
        if (password) updates.password = password;
        updates.role = role;
        updates.authorizedClasses = authClasses;

        const saveBtn = document.querySelector('#editUserModal .confirm');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = '儲存中...';

        try {
            const res = await fetch(`${SCRIPT_URL}?action=updateUser&username=${encodeURIComponent(username)}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
            const result = await res.json();
            if (result.success) {
                showSuccess('用戶資料已更新');
                closeEditUserModal();
                loadUserList();
            } else {
                showError(result.error || '更新失敗');
            }
        } catch (err) {
            showError('網路錯誤');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    }

    function closeEditUserModal() {
        document.getElementById('editUserModal').style.display = 'none';
        selectedClasses.clear();
    }

    function confirmDeleteUser(username) {
        if (currentUser.role !== 'admin') return;
        if (confirm(`確定要刪除用戶 ${username} 嗎？`)) {
            deleteUser(username);
        }
    }

    async function deleteUser(username) {
        const res = await fetch(`${SCRIPT_URL}?action=deleteUser&username=${encodeURIComponent(username)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess('用戶已刪除');
            loadUserList();
        } else {
            showError(result.error || '刪除失敗');
        }
    }

    // ---------- 審批請求處理 ----------
    async function approveRequest(id) {
        const res = await fetch(`${SCRIPT_URL}?action=approveRequest&id=${id}&approver=${encodeURIComponent(currentUser.username)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess('請求已批准');
            await loadPendingApprovals();
            await fetchAllStudents();
            renderNoteListByClass();
            updateAttendanceList();
            updateRentalList();
        } else {
            showError(result.error || '批准失敗');
        }
    }

    async function rejectRequest(id) {
        const res = await fetch(`${SCRIPT_URL}?action=rejectRequest&id=${id}&approver=${encodeURIComponent(currentUser.username)}`);
        const result = await res.json();
        if (result.success) {
            showSuccess('請求已拒絕');
            await loadPendingApprovals();
        } else {
            showError(result.error || '拒絕失敗');
        }
    }

    // ---------- 繳費上傳 ----------
document.getElementById('paymentUploadInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) {
        showError('請選擇圖片檔案');
        return;
    }
    if (!file.type.startsWith('image/')) {
        showError('請選擇圖片格式的檔案');
        this.value = '';
        return;
    }
    selectedPaymentFile = file;
    console.log('✅ 已選擇繳費憑證：', file.name, '大小：', file.size, '類型：', file.type);
    
    // 如果有待處理的新學生，直接開啟並預填
    if (pendingNewStudent) {
        openPaymentStudentModal(pendingNewStudent.name, pendingNewStudent.className);
        pendingNewStudent = null; // 使用後清除
    } else {
        openPaymentStudentModal();
    }
});

function openPaymentStudentModal(prefillName = '', prefillClass = '') {
    document.getElementById('paymentStudentSearch').value = prefillName;
    document.getElementById('paymentSelectedClass').value = prefillClass;
    document.getElementById('paymentDate').value = getTodayUTC8();
    if (prefillName && prefillClass) {
        selectedPaymentStudent = prefillName;
        selectedPaymentClass = prefillClass;
    }
    document.getElementById('paymentStudentModal').style.display = 'flex';
    setupPaymentSearch();
}

    function closePaymentModal() {
        document.getElementById('paymentStudentModal').style.display = 'none';
    }

function setupPaymentSearch() {
    const searchInput = document.getElementById('paymentStudentSearch');
    const dropdown = document.getElementById('paymentStudentDropdown');
    const newInput = searchInput.cloneNode(true);
    searchInput.parentNode.replaceChild(newInput, searchInput);
    newInput.addEventListener('input', function(e) {
        const kw = e.target.value.trim().toLowerCase();
        if (kw.length < 1) { dropdown.style.display = 'none'; return; }
        const filtered = getFilteredStudents().filter(s => s.name.toLowerCase().includes(kw));  // ← 修改處
        if (filtered.length === 0) { dropdown.style.display = 'none'; return; }
        let html = '';
        filtered.forEach(s => html += `<div class="dropdown-item" onclick="selectPaymentStudent('${s.name}', '${s.class}')">${s.name} (${s.class})</div>`);
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
    });
    document.addEventListener('click', function(e) {
        if (!newInput.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none';
    });
}

    window.selectPaymentStudent = function(name, className) {
        document.getElementById('paymentStudentSearch').value = name;
        document.getElementById('paymentSelectedClass').value = className;
        selectedPaymentStudent = name;
        selectedPaymentClass = className;
        document.getElementById('paymentStudentDropdown').style.display = 'none';
    };

    function confirmPaymentUpload() {
        const student = selectedPaymentStudent || document.getElementById('paymentStudentSearch').value.trim();
        const className = selectedPaymentClass || document.getElementById('paymentSelectedClass').value;
        const paymentDate = document.getElementById('paymentDate').value;
        
        console.log('📋 確認上傳，selectedPaymentFile =', selectedPaymentFile);

        if (!student || !className || !paymentDate) {
            showError('請填寫完整資料');
            return;
        }
        if (!selectedPaymentFile) {
            showError('請先選擇繳費憑證圖片');
            closePaymentModal();
            document.getElementById('paymentUploadInput').value = '';
            return;
        }
        closePaymentModal();

        currentConfirmCallback = async () => {
            closeConfirmModal();
            await uploadPaymentPhoto(student, className, paymentDate);
        };
        document.getElementById('confirmTitle').textContent = '確認繳費';
        document.getElementById('confirmMessage').textContent = `學生：${student}\n班級：${className}\n繳費日期：${paymentDate}\n確定上傳？`;
        document.getElementById('confirmBtn').onclick = currentConfirmCallback;
        document.getElementById('confirmModal').style.display = 'flex';
    }


    async function uploadPaymentPhoto(studentName, className, paymentDate) {
        if (!selectedPaymentFile) {
            showError('沒有選擇繳費憑證');
            return;
        }

        showLoadingSpinner('💰 繳費憑證上傳中，請勿關閉頁面...');

        try {
            console.log('開始壓縮繳費圖片');
            const compressedBase64 = await compressImage(selectedPaymentFile);
            console.log('壓縮完成，長度：', compressedBase64.length);

            const params = new URLSearchParams({
                imageData: compressedBase64,
                fileName: selectedPaymentFile.name,
                uploader: currentUser.username,
                studentName: studentName,
                class: className,
                paymentDate: paymentDate
            });

            console.log('發送請求至後端');
            const res = await fetch(`${SCRIPT_URL}?action=uploadPaymentPhoto`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });

            const result = await res.json();
            console.log('後端回應：', result);

            if (result.success) {
                showSuccess('繳費憑證上傳成功！');
                await loadPaymentNotifications();
                newStudentNotifications = newStudentNotifications.filter(n => n.name !== studentName);
                renderNotificationBody();
            } else {
                showError(result.error || '上傳失敗');
            }
        } catch (err) {
            console.error('上傳過程錯誤：', err);
            showError('網路錯誤：' + err.message);
        } finally {
            hideLoadingSpinner();
            selectedPaymentFile = null;
            document.getElementById('paymentUploadInput').value = '';
        }
    }

    // ---------- 課堂相片上傳 ----------
    document.getElementById('photoUploadInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            showError('請選擇圖片檔案');
            return;
        }
        if (!file.type.startsWith('image/')) {
            showError('請選擇圖片格式的檔案');
            this.value = '';
            return;
        }
        selectedPhotoFile = file;
        console.log('已選擇相片：', file.name);
        openClassSelectModal();
    });

    function openClassSelectModal() {
        const select = document.getElementById('photoClassSelect');
        select.innerHTML = '<option value="">-- 請選擇班級 --</option>';
        const allowedClasses = getAuthorizedClasses();
        let classList = allowedClasses === '*' ? allClasses : allowedClasses;
        classList.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            select.appendChild(option);
        });
        document.getElementById('classSelectModal').style.display = 'flex';
    }

    function closeClassSelectModal() {
        document.getElementById('classSelectModal').style.display = 'none';
    }

    function confirmClassSelection() {
        const selectedClass = document.getElementById('photoClassSelect').value;
        if (!selectedClass) {
            showError('請選擇班級');
            return;
        }
        if (!selectedPhotoFile) {
            showError('沒有選擇照片，請重新選擇檔案');
            closeClassSelectModal();
            return;
        }
        closeClassSelectModal();
        currentConfirmCallback = async () => {
            closeConfirmModal();
            await uploadPhoto(selectedClass);
        };
        document.getElementById('confirmTitle').textContent = '確認班級';
        document.getElementById('confirmMessage').textContent = `您選擇的班級是「${selectedClass}」，確定要上傳這張照片嗎？`;
        document.getElementById('confirmBtn').onclick = currentConfirmCallback;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    async function uploadPhoto(className) {
        if (!selectedPhotoFile) {
            showError('沒有選擇照片');
            return;
        }

        showLoadingSpinner('📸 相片上傳中，請勿關閉頁面...');

        try {
            console.log('開始壓縮圖片');
            const compressedBase64 = await compressImage(selectedPhotoFile);
            console.log('壓縮完成，長度：', compressedBase64.length);

            const params = new URLSearchParams({
                imageData: compressedBase64,
                fileName: selectedPhotoFile.name,
                uploader: currentUser.username,
                class: className
            });

            console.log('發送請求至後端');
            const res = await fetch(`${SCRIPT_URL}?action=uploadPhoto`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });

            const result = await res.json();
            console.log('後端回應：', result);

            if (result.success) {
                showSuccess('相片上傳成功！');
            } else {
                showError(result.error || '上傳失敗');
            }
        } catch (err) {
            console.error('上傳過程錯誤：', err);
            showError('網路錯誤：' + err.message);
        } finally {
            hideLoadingSpinner();
            selectedPhotoFile = null;
            document.getElementById('photoUploadInput').value = '';
        }
    }

    // 圖片壓縮函數
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (readerEvent) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1600;
                    if (width > height && width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(compressedBase64);
                };
                img.onerror = reject;
                img.src = readerEvent.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // ---------- 自訂對話框控制 ----------
    function closeNoteModal() {
        document.getElementById('noteModal').style.display = 'none';
        currentNoteTarget = null;
        const saveBtn = document.getElementById('saveNoteBtn');
        const cancelBtn = document.querySelector('#noteModal .cancel');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = '儲存';
        }
        if (cancelBtn) cancelBtn.disabled = false;
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.querySelector('#confirmModal .cancel');
        confirmBtn.disabled = false;
        confirmBtn.textContent = '確定';
        cancelBtn.disabled = false;
        currentConfirmCallback = null;
    }

    // ---------- 載入中控制 ----------
    function showLoadingSpinner(message) {
        const spinner = document.getElementById('loadingSpinner');
        const p = spinner.querySelector('p');
        if (p) p.textContent = message || '載入中，請稍後...';
        spinner.style.display = 'flex';
    }

    function hideLoadingSpinner() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // ---------- 訊息顯示 ----------
    function showSuccess(msg) {
        const msgDiv = document.getElementById('message');
        msgDiv.innerHTML = `<div class="success">✅ ${msg}</div>`;
        setTimeout(() => msgDiv.innerHTML = '', 4000);
    }

    function showError(msg) {
        const msgDiv = document.getElementById('message');
        msgDiv.innerHTML = `<div class="error">❌ ${msg}</div>`;
        setTimeout(() => msgDiv.innerHTML = '', 4000);
    }
    // ---------- 頁面載入時自動登入 ----------
window.addEventListener('DOMContentLoaded', async function() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            // 隱藏登入表單，顯示主要內容
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // 更新使用者資訊顯示
            let roleName = '助教';
            if (currentUser.role === 'admin') roleName = '管理員';
            else if (currentUser.role === 'coach') roleName = '教練';
            document.getElementById('userInfoDisplay').textContent = `👤 ${currentUser.username} (${roleName})`;

            // 顯示載入中，載入所有資料
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('appContent').style.display = 'none';
            await loadAllData();
        } catch (e) {
            console.error('自動登入失敗', e);
            localStorage.removeItem('currentUser'); // 清除錯誤的資料
        }
    }
});
</script>
</body>
</html>







