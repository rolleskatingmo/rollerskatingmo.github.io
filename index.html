<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>滾軸溜冰私教輪滑團點名系統</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
    .container { margin: 20px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .button { padding: 10px 20px; background-color: red; color: white; border: none; cursor: pointer; margin-top: 10px; }
    .button:hover { background-color: #cc0000; }
    .input { padding: 10px; width: 300px; margin: 5px 0; }
    label { font-weight: bold; }
    #responseMessage { margin-top: 20px; padding: 10px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 5px; display: none; }
    #studentButtons { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; } /* 新增間隔並讓按鈕換行 */
    #studentButtons button { min-width: 120px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>家長入口</h2>
    <label for="studentName">學員姓名：</label>
    <input type="text" id="studentName" class="input" placeholder="輸入學員姓名">
    <button class="button" onclick="queryRecord()">查詢記錄</button>
    <button class="button" onclick="changeClass()">調課</button>
    <button class="button" onclick="requestLeave()">請假</button>

    <h2>教練入口</h2>
    <label for="coachPassword">密碼：</label>
    <input type="password" id="coachPassword" class="input" placeholder="輸入密碼">
    <button class="button" onclick="verifyCoachPassword()">登錄</button>

    <div id="coachFunctions" style="display:none;">
      <button class="button" onclick="showClassStudents()">點名</button>
      <button class="button" onclick="addStudent()">新增學生</button>
      <button class="button" onclick="addClassHours()">新增課堂數</button>
    </div>
    
    <div id="studentButtons" style="margin-top:20px;"></div>  <!-- 顯示學生按鈕的地方 -->

    <!-- 這是顯示訊息的地方 -->
    <div id="responseMessage"></div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyCygfKQyI-hjr4s0djt96tunLfjp8XL7A-VWcf4wXP-khmFPB1jU3ZDVLDMFAMFmmdIQ/exec";

    // 查詢學員記錄
    function queryRecord() {
      var studentName = document.getElementById("studentName").value;
      const params = { studentName: studentName, action: 'queryRecord' };

      fetch(scriptUrl + '?' + new URLSearchParams(params))
        .then(response => response.json())
        .then(data => {
          if (data) {
            showResponseMessage(`姓名: ${data.name}\n班級: ${data.class}\n剩餘課堂數: ${data.remainingClasses}\n請假次數: ${data.leaveCount}\n請假日期: ${data.leaveDates}`);
          } else {
            showResponseMessage("未找到學員資料");
          }
        })
        .catch(error => showResponseMessage("Error fetching data: " + error));
    }

    // 顯示回傳訊息到頁面上
    function showResponseMessage(message) {
      const responseMessageDiv = document.getElementById("responseMessage");
      responseMessageDiv.style.display = "block"; // 顯示訊息區塊
      responseMessageDiv.textContent = message; // 設置訊息內容
    }

    // 顯示班級學生列表並生成按鈕
    function showClassStudents() {
      const classes = ["A1", "A2", "A3", "A4", "B1", "B2", "B3", "B4", "B5", "B6", "C1", "C2"];

      // 開新頁顯示學生名單
      const newWindow = window.open('', '', 'width=800,height=600');
      newWindow.document.write('<html><head><title>班級學生名單</title></head><body>');
      newWindow.document.write('<h2>班級學生名單</h2>');

      // 循環遍歷所有班級並顯示學生名單
      classes.forEach(className => {
        fetch(scriptUrl + '?' + new URLSearchParams({ className: className, action: 'getClassStudents' }))
          .then(response => response.json())
          .then(students => {
            newWindow.document.write(`<h3>${className}</h3>`);
            students.forEach(student => {
              // 預設紅色按鈕，尚未點名
              newWindow.document.write(`<button style="background-color: red;" id="${className}-${student}" onclick="markAttendance('${student}', '${className}', this)">${student}</button><br>`);
            });
          });
      });

      newWindow.document.write('</body></html>');
    }

    // 點名功能：扣減剩餘課堂數並標記顏色
    function markAttendance(studentName, className, buttonElement) {
      const params = { studentName: studentName, className: className, action: 'markAttendance' };

      fetch(scriptUrl + '?' + new URLSearchParams(params))
        .then(response => response.text())
        .then(data => {
          showResponseMessage(data);  // 返回点名成功消息

          // 記錄點名的日期（格式：mmdd, mmdd）
          const date = new Date();
          const formattedDate = `${("0" + (date.getMonth() + 1)).slice(-2)}${("0" + date.getDate()).slice(-2)}`;

          // 更新課堂記錄，將日期追加到記錄中
          const updateParams = { studentName: studentName, className: className, action: 'updateClassRecord', date: formattedDate };
          fetch(scriptUrl + '?' + new URLSearchParams(updateParams));

          // 將按鈕顏色變為綠色，表示已經點名
          buttonElement.style.backgroundColor = 'green';
        })
        .catch(error => showResponseMessage("Error fetching data: " + error));
    }

  </script>
</body>
</html>
